This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
public/
  assets/
    perezoso/
      image-1.png
      image-2.png
      image-3.png
      image-4.png
      image-5.png
      image-6.png
      image-7.png
      image-8.png
      LogoPerezoso.png
  clients/
    mare_cafe/
      flyer_template_1_1769954037447.png
      flyer_template_2_1769954052827.png
      flyer_template_3_1769954068639.png
      logo.png
  file.svg
  globe.svg
  logo-mare.png
  next.svg
  perezoso-menu.html
  vercel.svg
  window.svg
src/
  app/
    actions/
      marketing.ts
    admin/
      error.tsx
      page.tsx
    auth/
      login/
        page.tsx
    client/
      menu/
        page.tsx
      page.tsx
    promo/
      [id]/
        page.tsx
    staff/
      page.tsx
    error.tsx
    favicon.ico
    globals.css
    layout.tsx
    manifest.ts
    page.tsx
  components/
    admin/
      ClientsTab.tsx
      EmailEditor.tsx
    client/
      menu/
        CategoryTabs.tsx
        MenuHeader.tsx
        ProductDetailModal.tsx
        ProductGrid.tsx
      AboutUs.tsx
      ClientHeader.tsx
      MenuButton.tsx
      NewsFeed.tsx
      QRFloatingButton.tsx
      QRModal.tsx
      RewardsCard.tsx
      StampProgress.tsx
      WelcomeHero.tsx
    IOSInstallPrompt.tsx
    PoweredBy.tsx
    Scanner.tsx
  config/
    clients/
      mare_cafe.ts
      perezoso_cafe.ts
    types.ts
  context/
    ClientConfigContext.tsx
  data/
    menu-data.ts
  lib/
    config-loader.ts
    shop-service.ts
    supabase-admin.ts
    supabase.ts
  types/
    menu.ts
supabase/
  migrations/
    02_phase2_schema.sql
    03_fix_function.sql
    04_rename_role.sql
    05_security_rules.sql
    06_redeem_logic.sql
    07_gamification.sql
    20240201173000_create_campaigns.sql
    20240204_client_features.sql
    20260208_create_shops_table.sql
    20260208_fix_redeem_logic_dynamic.sql
    20260208_secure_pins.sql
  schema.sql
.gitignore
Auditoria_App_Cafe_Loyalty.md
eslint.config.mjs
next.config.ts
package.json
postcss.config.mjs
README.md
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/perezoso-menu.html">
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perezoso Cafe - Pide y RelÃ¡jate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'perezoso': {
                            'dark': '#2E2333',
                            'darker': '#1F181F',
                            'brown': '#3D2914',
                            'orange': '#F5A623',
                            'gold': '#FFAE00',
                            'cream': '#FFF5E1',
                            'cream-dark': '#E8D5B7',
                        }
                    },
                    fontFamily: {
                        'fredoka': ['Fredoka', 'sans-serif'],
                    },
                    borderRadius: {
                        '4xl': '2rem',
                        '5xl': '2.5rem',
                    }
                }
            }
        }
    </script>
    <style>
        * {
            font-family: 'Fredoka', sans-serif;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #2E2333;
        }
        ::-webkit-scrollbar-thumb {
            background: #F5A623;
            border-radius: 10px;
        }
        
        /* Smooth animations */
        .cart-bounce {
            animation: bounce 0.5s ease;
        }
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-perezoso-dark min-h-screen" x-data="cafeApp()">

    <!-- Header Sticky -->
    <header class="sticky top-0 z-40 bg-perezoso-darker/95 backdrop-blur-md border-b border-perezoso-brown/30 shadow-lg">
        <div class="max-w-lg mx-auto px-4 py-3 flex items-center justify-between">
            <!-- Logo -->
            <div class="flex items-center gap-2">
                <img src="assets/perezoso/LogoPerezoso.png" alt="Perezoso Cafe" class="h-14 w-auto">
            </div>
            
            <!-- Cart Button -->
            <button 
                @click="cartOpen = true" 
                class="relative bg-perezoso-orange hover:bg-perezoso-gold text-perezoso-brown p-3 rounded-2xl transition-all duration-300 shadow-lg hover:shadow-perezoso-orange/30 hover:scale-105"
                :class="{ 'cart-bounce': cartAnimation }"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <!-- Cart Counter -->
                <span 
                    x-show="cartCount > 0" 
                    x-text="cartCount"
                    class="absolute -top-2 -right-2 bg-perezoso-cream text-perezoso-brown text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center shadow-md"
                    x-transition
                ></span>
            </button>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="bg-gradient-to-b from-perezoso-darker to-perezoso-dark px-4 py-8 text-center">
        <h1 class="text-3xl font-bold text-perezoso-cream mb-2">Bienvenido, amigo ðŸ¦¥</h1>
        <p class="text-perezoso-cream-dark text-lg">Pide y relÃ¡jate... sin prisas</p>
    </section>

    <!-- Category Tabs -->
    <nav class="sticky top-[76px] z-30 bg-perezoso-dark border-b border-perezoso-brown/20 shadow-md">
        <div class="max-w-lg mx-auto px-4 py-3 flex gap-2 overflow-x-auto scrollbar-hide">
            <template x-for="category in categories" :key="category.id">
                <button 
                    @click="activeCategory = category.id"
                    :class="activeCategory === category.id 
                        ? 'bg-perezoso-orange text-perezoso-brown shadow-lg shadow-perezoso-orange/20' 
                        : 'bg-perezoso-brown/40 text-perezoso-cream hover:bg-perezoso-brown/60'"
                    class="px-5 py-2.5 rounded-3xl font-semibold whitespace-nowrap transition-all duration-300 text-sm"
                    x-text="category.name"
                ></button>
            </template>
        </div>
    </nav>

    <!-- Products Grid -->
    <main class="max-w-lg mx-auto px-4 py-6 pb-24">
        <div class="grid grid-cols-2 gap-4">
            <template x-for="product in filteredProducts" :key="product.id">
                <div 
                    @click="openProductModal(product)"
                    class="bg-perezoso-darker rounded-4xl overflow-hidden shadow-xl border border-perezoso-brown/20 hover:border-perezoso-orange/50 transition-all duration-300 hover:scale-[1.02] cursor-pointer group"
                >
                    <!-- Product Image -->
                    <div class="aspect-square bg-perezoso-brown/30 relative overflow-hidden">
                        <img 
                            :src="product.image" 
                            :alt="product.name"
                            class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                            onerror="this.src='https://placehold.co/300x300/3D2914/FFF5E1?text=ðŸ¦¥+Foto'"
                        >
                        <!-- Quick Add Button -->
                        <button 
                            @click.stop="addToCart(product)"
                            class="absolute bottom-3 right-3 bg-perezoso-orange hover:bg-perezoso-gold text-perezoso-brown w-10 h-10 rounded-2xl flex items-center justify-center shadow-lg transition-all duration-300 hover:scale-110"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Product Info -->
                    <div class="p-4">
                        <h3 class="text-perezoso-cream font-semibold text-sm mb-1 line-clamp-2" x-text="product.name"></h3>
                        <p class="text-perezoso-cream-dark text-xs mb-2 line-clamp-1" x-text="product.description"></p>
                        <p class="text-perezoso-orange font-bold text-lg">$<span x-text="product.price.toLocaleString()"></span></p>
                    </div>
                </div>
            </template>
        </div>
        
        <!-- Empty State -->
        <div x-show="filteredProducts.length === 0" class="text-center py-16">
            <span class="text-6xl mb-4 block">ðŸ¦¥</span>
            <p class="text-perezoso-cream-dark text-lg">AÃºn no hay productos aquÃ­...</p>
            <p class="text-perezoso-cream-dark/60 text-sm">Pero pronto llegarÃ¡n, sin prisa</p>
        </div>
    </main>

    <!-- Product Modal -->
    <div 
        x-show="productModalOpen" 
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 z-50 flex items-end justify-center bg-black/60 backdrop-blur-sm"
        @click.self="productModalOpen = false"
    >
        <div 
            x-show="productModalOpen"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="translate-y-full"
            x-transition:enter-end="translate-y-0"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="translate-y-0"
            x-transition:leave-end="translate-y-full"
            class="bg-perezoso-darker w-full max-w-lg rounded-t-5xl shadow-2xl max-h-[85vh] overflow-hidden"
        >
            <!-- Modal Header Image -->
            <div class="relative aspect-video bg-perezoso-brown/30">
                <img 
                    :src="selectedProduct?.image" 
                    :alt="selectedProduct?.name"
                    class="w-full h-full object-cover"
                    onerror="this.src='https://placehold.co/600x400/3D2914/FFF5E1?text=ðŸ¦¥+Foto'"
                >
                <button 
                    @click="productModalOpen = false"
                    class="absolute top-4 right-4 bg-perezoso-dark/80 text-perezoso-cream w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-sm hover:bg-perezoso-orange hover:text-perezoso-brown transition-colors"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="p-6">
                <h2 class="text-2xl font-bold text-perezoso-cream mb-2" x-text="selectedProduct?.name"></h2>
                <p class="text-perezoso-cream-dark mb-4" x-text="selectedProduct?.description"></p>
                
                <!-- Quantity Selector -->
                <div class="flex items-center justify-between bg-perezoso-dark rounded-3xl p-4 mb-6">
                    <span class="text-perezoso-cream font-medium">Cantidad</span>
                    <div class="flex items-center gap-4">
                        <button 
                            @click="modalQuantity = Math.max(1, modalQuantity - 1)"
                            class="bg-perezoso-brown/50 text-perezoso-cream w-10 h-10 rounded-xl flex items-center justify-center hover:bg-perezoso-brown transition-colors"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" />
                            </svg>
                        </button>
                        <span class="text-perezoso-cream font-bold text-xl w-8 text-center" x-text="modalQuantity"></span>
                        <button 
                            @click="modalQuantity++"
                            class="bg-perezoso-orange text-perezoso-brown w-10 h-10 rounded-xl flex items-center justify-center hover:bg-perezoso-gold transition-colors"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Add to Cart Button -->
                <button 
                    @click="addToCartFromModal()"
                    class="w-full bg-perezoso-orange hover:bg-perezoso-gold text-perezoso-brown font-bold py-4 rounded-3xl transition-all duration-300 shadow-lg hover:shadow-perezoso-orange/30 flex items-center justify-center gap-3 text-lg"
                >
                    <span>Agregar al pedido</span>
                    <span class="bg-perezoso-brown/20 px-3 py-1 rounded-xl">$<span x-text="((selectedProduct?.price || 0) * modalQuantity).toLocaleString()"></span></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Cart Slide-over -->
    <div 
        x-show="cartOpen" 
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm"
        @click.self="cartOpen = false"
    >
        <div 
            x-show="cartOpen"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="translate-x-full"
            x-transition:enter-end="translate-x-0"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="translate-x-0"
            x-transition:leave-end="translate-x-full"
            class="absolute right-0 top-0 h-full w-full max-w-md bg-perezoso-darker shadow-2xl flex flex-col"
        >
            <!-- Cart Header -->
            <div class="flex items-center justify-between p-6 border-b border-perezoso-brown/30">
                <h2 class="text-2xl font-bold text-perezoso-cream flex items-center gap-2">
                    ðŸ¦¥ Tu Pedido
                </h2>
                <button 
                    @click="cartOpen = false"
                    class="text-perezoso-cream-dark hover:text-perezoso-cream p-2 rounded-xl hover:bg-perezoso-brown/30 transition-colors"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Cart Items -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Empty Cart -->
                <div x-show="cart.length === 0" class="text-center py-16">
                    <span class="text-6xl mb-4 block">ðŸ˜´</span>
                    <p class="text-perezoso-cream-dark text-lg mb-2">Tu carrito estÃ¡ descansando...</p>
                    <p class="text-perezoso-cream-dark/60 text-sm">Agrega algo rico para comenzar</p>
                </div>
                
                <!-- Cart Items List -->
                <div x-show="cart.length > 0" class="space-y-4">
                    <template x-for="(item, index) in cart" :key="item.id + '-' + index">
                        <div class="bg-perezoso-dark rounded-3xl p-4 flex gap-4 items-center">
                            <img 
                                :src="item.image" 
                                :alt="item.name"
                                class="w-20 h-20 rounded-2xl object-cover"
                                onerror="this.src='https://placehold.co/100x100/3D2914/FFF5E1?text=ðŸ¦¥'"
                            >
                            <div class="flex-1 min-w-0">
                                <h3 class="text-perezoso-cream font-semibold text-sm truncate" x-text="item.name"></h3>
                                <p class="text-perezoso-orange font-bold">$<span x-text="item.price.toLocaleString()"></span></p>
                                
                                <!-- Quantity Controls -->
                                <div class="flex items-center gap-2 mt-2">
                                    <button 
                                        @click="decreaseQuantity(index)"
                                        class="bg-perezoso-brown/50 text-perezoso-cream w-7 h-7 rounded-lg flex items-center justify-center hover:bg-perezoso-brown transition-colors text-sm"
                                    >âˆ’</button>
                                    <span class="text-perezoso-cream font-medium w-6 text-center" x-text="item.quantity"></span>
                                    <button 
                                        @click="increaseQuantity(index)"
                                        class="bg-perezoso-orange text-perezoso-brown w-7 h-7 rounded-lg flex items-center justify-center hover:bg-perezoso-gold transition-colors text-sm"
                                    >+</button>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-perezoso-cream font-bold">$<span x-text="(item.price * item.quantity).toLocaleString()"></span></p>
                                <button 
                                    @click="removeFromCart(index)"
                                    class="text-red-400 hover:text-red-300 text-xs mt-1 hover:underline"
                                >Quitar</button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- Cart Footer -->
            <div x-show="cart.length > 0" class="border-t border-perezoso-brown/30 p-6 bg-perezoso-darker">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-perezoso-cream-dark text-lg">Total</span>
                    <span class="text-perezoso-cream text-2xl font-bold">$<span x-text="cartTotal.toLocaleString()"></span></span>
                </div>
                <button 
                    @click="checkout()"
                    class="w-full bg-perezoso-orange hover:bg-perezoso-gold text-perezoso-brown font-bold py-4 rounded-3xl transition-all duration-300 shadow-lg hover:shadow-perezoso-orange/30 text-lg"
                >
                    Pedir con calma ðŸ¦¥
                </button>
                <button 
                    @click="clearCart()"
                    class="w-full mt-3 text-perezoso-cream-dark hover:text-red-400 py-2 text-sm transition-colors"
                >
                    Vaciar carrito
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div 
        x-show="toastVisible"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="translate-y-full opacity-0"
        x-transition:enter-end="translate-y-0 opacity-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="translate-y-0 opacity-100"
        x-transition:leave-end="translate-y-full opacity-0"
        class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 bg-perezoso-orange text-perezoso-brown px-6 py-3 rounded-2xl shadow-lg font-medium flex items-center gap-2"
    >
        <span>âœ“</span>
        <span x-text="toastMessage"></span>
    </div>

    <script>
        function cafeApp() {
            return {
                activeCategory: 'cafes',
                cartOpen: false,
                productModalOpen: false,
                selectedProduct: null,
                modalQuantity: 1,
                cart: [],
                cartAnimation: false,
                toastVisible: false,
                toastMessage: '',
                
                categories: [
                    { id: 'cafes', name: 'â˜• CafÃ©s' },
                    { id: 'postres', name: 'ðŸ° Postres' },
                    { id: 'especiales', name: 'âœ¨ Especiales' },
                    { id: 'frios', name: 'ðŸ§Š FrÃ­os' },
                ],
                
                products: [
                    // CafÃ©s
                    { id: 1, category: 'cafes', name: 'Latte Perezoso', description: 'Espresso suave con leche cremosa', price: 4500, image: 'assets/perezoso/latte.jpg' },
                    { id: 2, category: 'cafes', name: 'Cappuccino Tranquilo', description: 'Espresso, leche espumada y canela', price: 4800, image: 'assets/perezoso/cappuccino.jpg' },
                    { id: 3, category: 'cafes', name: 'Americano Relajado', description: 'Espresso doble con agua caliente', price: 3500, image: 'assets/perezoso/americano.jpg' },
                    { id: 4, category: 'cafes', name: 'Mocha DormilÃ³n', description: 'Espresso, chocolate y crema', price: 5200, image: 'assets/perezoso/mocha.jpg' },
                    
                    // Postres
                    { id: 5, category: 'postres', name: 'Torta de Zanahoria', description: 'Con frosting de queso crema', price: 4200, image: 'assets/perezoso/carrot_cake.jpg' },
                    { id: 6, category: 'postres', name: 'Brownie Lento', description: 'Chocolate intenso con nueces', price: 3800, image: 'assets/perezoso/brownie.jpg' },
                    { id: 7, category: 'postres', name: 'Cheesecake Suave', description: 'Con coulis de frutos rojos', price: 4500, image: 'assets/perezoso/cheesecake.jpg' },
                    { id: 8, category: 'postres', name: 'Cinnamon Roll', description: 'ReciÃ©n horneado con glaseado', price: 3500, image: 'assets/perezoso/cinnamon.jpg' },
                    
                    // Especiales
                    { id: 9, category: 'especiales', name: 'Golden Sloth Latte', description: 'CÃºrcuma, jengibre y leche de avena', price: 5500, image: 'assets/perezoso/golden_latte.jpg' },
                    { id: 10, category: 'especiales', name: 'Matcha Slow', description: 'Matcha ceremonial con leche', price: 5800, image: 'assets/perezoso/matcha.jpg' },
                    { id: 11, category: 'especiales', name: 'Chai Perezoso', description: 'TÃ© chai especiado con espuma', price: 4800, image: 'assets/perezoso/chai.jpg' },
                    { id: 12, category: 'especiales', name: 'Affogato Feliz', description: 'Helado de vainilla con espresso', price: 5000, image: 'assets/perezoso/affogato.jpg' },
                    
                    // FrÃ­os
                    { id: 13, category: 'frios', name: 'Cold Brew Suave', description: 'CafÃ© frÃ­o de 12 horas', price: 4800, image: 'assets/perezoso/cold_brew.jpg' },
                    { id: 14, category: 'frios', name: 'FrappÃ© Chocolate', description: 'Helado y cremoso', price: 5500, image: 'assets/perezoso/frappe.jpg' },
                    { id: 15, category: 'frios', name: 'Limonada de Coco', description: 'Refrescante y tropical', price: 4000, image: 'assets/perezoso/limonada.jpg' },
                    { id: 16, category: 'frios', name: 'Iced Latte', description: 'Latte frÃ­o con hielo', price: 4500, image: 'assets/perezoso/iced_latte.jpg' },
                ],
                
                get filteredProducts() {
                    return this.products.filter(p => p.category === this.activeCategory);
                },
                
                get cartCount() {
                    return this.cart.reduce((sum, item) => sum + item.quantity, 0);
                },
                
                get cartTotal() {
                    return this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                },
                
                openProductModal(product) {
                    this.selectedProduct = product;
                    this.modalQuantity = 1;
                    this.productModalOpen = true;
                },
                
                addToCart(product, quantity = 1) {
                    const existingIndex = this.cart.findIndex(item => item.id === product.id);
                    
                    if (existingIndex >= 0) {
                        this.cart[existingIndex].quantity += quantity;
                    } else {
                        this.cart.push({ ...product, quantity });
                    }
                    
                    this.triggerCartAnimation();
                    this.showToast('Agregado al pedido ðŸ¦¥');
                },
                
                addToCartFromModal() {
                    if (this.selectedProduct) {
                        this.addToCart(this.selectedProduct, this.modalQuantity);
                        this.productModalOpen = false;
                    }
                },
                
                increaseQuantity(index) {
                    this.cart[index].quantity++;
                },
                
                decreaseQuantity(index) {
                    if (this.cart[index].quantity > 1) {
                        this.cart[index].quantity--;
                    } else {
                        this.removeFromCart(index);
                    }
                },
                
                removeFromCart(index) {
                    this.cart.splice(index, 1);
                },
                
                clearCart() {
                    if (confirm('Â¿Vaciar el carrito?')) {
                        this.cart = [];
                        this.showToast('Carrito vaciado');
                    }
                },
                
                checkout() {
                    alert(`Â¡Pedido enviado! ðŸ¦¥\n\nTotal: $${this.cartTotal.toLocaleString()}\n\nGracias por tu paciencia, tu pedido llegarÃ¡... con calma.`);
                    this.cart = [];
                    this.cartOpen = false;
                },
                
                triggerCartAnimation() {
                    this.cartAnimation = true;
                    setTimeout(() => this.cartAnimation = false, 500);
                },
                
                showToast(message) {
                    this.toastMessage = message;
                    this.toastVisible = true;
                    setTimeout(() => this.toastVisible = false, 2000);
                }
            }
        }
    </script>
</body>
</html>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="src/app/actions/marketing.ts">
'use server';


import { Resend } from 'resend';
import { supabaseAdmin } from '@/lib/supabase-admin';

// Initialize Supabase Client (Service Role needed for mass emailing to avoid RLS issues)
const supabase = supabaseAdmin;

const resend = new Resend(process.env.RESEND_API_KEY || 're_123456789'); // Placeholder if missing

export async function sendCampaign(formData: FormData) {
    const title = formData.get('title') as string;
    const content = formData.get('content') as string;
    const audience = formData.get('audience') as string;
    const testEmail = formData.get('testEmail') as string | null;
    const html = formData.get('html') as string | null;
    const campaignId = formData.get('campaignId') as string | null;

    console.log(`ðŸš€ Starting Campaign: ${title} (ID: ${campaignId || 'None'})`);

    try {
        let targets: string[] = [];

        // 1. Determine Targets
        if (testEmail) {
            console.log(`ðŸ§ª Test Mode: Sending only to ${testEmail}`);
            targets = [testEmail];
        } else {
            console.log(`ðŸ‘¥ Database Mode: Fetching users for audience: ${audience}`);

            let query = supabase.from('profiles').select('email');

            // Apply Filters
            if (audience === 'Nivel 2+ (Frecuentes)') {
                query = query.gte('level', 2);
            } else if (audience === 'Nivel 3+ (VIP)') {
                query = query.gte('level', 3);
            }
            // 'Todos' gets everyone

            const { data, error } = await query;

            if (error) throw new Error(`DB Error: ${error.message}`);

            targets = data.map(p => p.email).filter(e => e && e.includes('@')); // Simple validation
            console.log(`âœ… Found ${targets.length} valid targets in Database.`);
        }

        if (targets.length === 0) {
            return { success: false, message: 'No se encontraron destinatarios vÃ¡lidos.' };
        }

        // 2. Send Emails (Batching or Loop)
        // For MVP, we loop. Resend has batch API too.

        // CHECK IF RESEND KEY IS REAL
        const hasKey = process.env.RESEND_API_KEY && !process.env.RESEND_API_KEY.startsWith('re_123');
        const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000'; // Define this in env vars

        if (!hasKey) {
            // SIMULATION MODE
            console.log('âš ï¸ No RESEND_API_KEY found. Simulating delivery.');
            await new Promise(r => setTimeout(r, 1500)); // Fake delay
            return {
                success: true,
                message: `[MODO SIMULACIÃ“N] CampaÃ±a procesada exitosamente para ${targets.length} usuarios. (Configura RESEND_API_KEY para envÃ­os reales).`
            };
        }

        // REAL SEND MODE
        const results = [];
        for (const email of targets) {
            // Generate Personalized Content
            let personalizedHtml = html || `
                <div style="font-family: sans-serif; color: #333;">
                    <h1 style="color: #1E3A8A;">Mare Cafe</h1>
                    <h2>${title}</h2>
                    <p>${content}</p>
                    <br/>
                    <div style="padding: 20px; background-color: #f3f4f6; border-radius: 10px;">
                        <p style="font-size: 12px; color: #888;">Este es un mensaje automÃ¡tico de tu tarjeta de fidelidad.</p>
                    </div>
                </div>
            `;

            if (campaignId) {
                const promoUrl = `${baseUrl}/promo/${campaignId}?user=${encodeURIComponent(email)}`;
                personalizedHtml = personalizedHtml.replace(/{{PROMO_LINK}}/g, promoUrl);
            }

            const result = await resend.emails.send({
                from: 'Mare Cafe <onboarding@resend.dev>', // Default Resend Testing Domain
                to: email,
                subject: title,
                html: personalizedHtml
            });
            results.push(result);

            // Rate Limit Delay (500ms)
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        const errors = results.filter(r => r.error);
        if (errors.length > 0) {
            console.error('Some emails failed:', errors);
            return { success: true, message: `Enviado a ${targets.length - errors.length} usuarios. (${errors.length} fallidos)` };
        }

        return { success: true, message: `Â¡Ã‰xito! Enviado a ${targets.length} usuarios.` };

    } catch (error: any) {
        console.error('Campaign Error:', error);
        return { success: false, message: error.message };
    }
}
</file>

<file path="src/app/admin/error.tsx">
'use client';

import { useEffect } from 'react';
import { ShieldAlert, RefreshCcw } from 'lucide-react';
import PoweredBy from '@/components/PoweredBy';

export default function AdminError({
    error,
    reset,
}: {
    error: Error & { digest?: string };
    reset: () => void;
}) {
    useEffect(() => {
        console.error(error);
    }, [error]);

    return (
        <div className="bg-slate-50 flex items-center justify-center min-h-[calc(100vh-80px)] md:min-h-screen p-6 font-sans">
            <div className="bg-white rounded-3xl shadow-xl p-8 max-w-md w-full text-center border border-red-100">
                <div className="bg-red-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6">
                    <ShieldAlert size={32} className="text-red-500" />
                </div>

                <h2 className="text-xl font-bold text-slate-800 mb-2">Error en el Panel de AdministraciÃ³n</h2>
                <p className="text-slate-500 text-sm mb-6">
                    No se pudo cargar el mÃ³dulo solicitado. Esto puede deberse a un problema de conexiÃ³n o permisos.
                </p>

                <div className="bg-slate-50 p-3 rounded-lg text-left mb-6 border border-slate-100 overflow-hidden">
                    <p className="text-[10px] font-mono text-slate-400 uppercase tracking-wider mb-1">Detalles TÃ©cnicos</p>
                    <p className="text-xs font-mono text-slate-600 truncate">{error.message}</p>
                </div>

                <div className="flex flex-col gap-3">
                    <button
                        onClick={() => reset()}
                        className="w-full bg-blue-900 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 hover:bg-blue-800 transition shadow-lg shadow-blue-900/10"
                    >
                        <RefreshCcw size={18} /> Recargar Panel
                    </button>
                    <button
                        onClick={() => window.location.reload()}
                        className="w-full bg-white text-slate-600 font-semibold py-3 rounded-xl border border-slate-200 hover:bg-slate-50 transition"
                    >
                        Forzar Recarga Completa
                    </button>
                </div>

                <div className="mt-8 opacity-70">
                    <PoweredBy />
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/app/admin/page.tsx">
import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { useClientConfig } from '@/context/ClientConfigContext';
import { ClientConfig } from '@/config/types';
import PoweredBy from '@/components/PoweredBy';
import { Users, Scan, Gift, TrendingUp, LogOut, Mail, Settings, Bell, ChevronRight, Send, Save, CreditCard, Clock } from 'lucide-react';
import { supabase } from '@/lib/supabase';
import {
    AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, BarChart, Bar
} from 'recharts';
import EmailEditor from '@/components/admin/EmailEditor';
import { Plus } from 'lucide-react';
import ClientsTab from '@/components/admin/ClientsTab';

export default function AdminDashboard() {
    const router = useRouter();
    const config = useClientConfig();
    const [loading, setLoading] = useState(true);
    const [activeTab, setActiveTab] = useState<'overview' | 'clients' | 'marketing' | 'settings' | 'activity'>('overview');

    // Metrics State
    const [metrics, setMetrics] = useState({
        totalClients: 0,
        scansToday: 0,
        redemptionsTotal: 0
    });

    const [chartData, setChartData] = useState<any[]>([]);
    const [activeChart, setActiveChart] = useState<'scans' | 'clients' | 'redemptions'>('scans');

    useEffect(() => {
        const init = async () => {
            // Config is already active via Context

            const { data: { user } } = await supabase.auth.getUser();
            if (!user) { router.push('/auth/login?role=staff'); return; }

            const { data: profile } = await supabase.from('profiles').select('role, client_code').eq('id', user.id).single();
            if (!profile || profile.role !== 'admin') {
                router.push('/staff');
                return;
            }

            // Client Isolation Check
            let isValidUser = true;
            if (config.code === 'perezoso_cafe') {
                if (profile.client_code !== 'perezoso_cafe') isValidUser = false;
            } else if (config.code === 'mare_cafe') {
                if (profile.client_code && profile.client_code !== 'mare_cafe') isValidUser = false;
            } else {
                if (profile.client_code && profile.client_code !== config.code) isValidUser = false;
            }

            if (!isValidUser) {
                alert(`Esta cuenta de administrador no pertenece a ${config.name}.`);
                await supabase.auth.signOut();
                router.push('/');
                return;
            }

            const fetchMetrics = async (cfg: ClientConfig) => {
                // 1. Clients
                let clientQuery = supabase.from('profiles').select('*', { count: 'exact', head: true }).eq('role', 'customer');
                if (cfg.code === 'mare_cafe') {
                    clientQuery = clientQuery.or('client_code.eq.mare_cafe,client_code.is.null');
                } else {
                    clientQuery = clientQuery.eq('client_code', cfg.code);
                }
                const { count: clientCount } = await clientQuery;

                // 2. Scans (Joined with Profiles)
                const today = new Date().toISOString().split('T')[0];
                let scansQuery = supabase.from('transaction_logs')
                    .select('id, profiles!transaction_logs_user_id_fkey!inner(client_code)', { count: 'exact', head: true })
                    .eq('type', 'add_stamp')
                    .gte('created_at', today);

                if (cfg.code === 'mare_cafe') {
                    scansQuery = scansQuery.or('client_code.eq.mare_cafe,client_code.is.null', { foreignTable: 'profiles' });
                } else {
                    scansQuery = scansQuery.eq('profiles.client_code', cfg.code);
                }
                const { count: dailyScans } = await scansQuery;

                // 3. Redemptions
                let redeemsQuery = supabase.from('transaction_logs')
                    .select('id, profiles!transaction_logs_user_id_fkey!inner(client_code)', { count: 'exact', head: true })
                    .eq('type', 'redeem_reward');

                if (cfg.code === 'mare_cafe') {
                    redeemsQuery = redeemsQuery.or('client_code.eq.mare_cafe,client_code.is.null', { foreignTable: 'profiles' });
                } else {
                    redeemsQuery = redeemsQuery.eq('profiles.client_code', cfg.code);
                }
                const { count: redemptions } = await redeemsQuery;

                setMetrics({
                    totalClients: clientCount || 0,
                    scansToday: dailyScans || 0,
                    redemptionsTotal: redemptions || 0
                });
            };

            const fetchChartData = async (cfg: ClientConfig) => {
                const today = new Date();
                const last7Days = Array.from({ length: 7 }, (_, i) => {
                    const d = new Date();
                    d.setDate(today.getDate() - (6 - i));
                    return d.toISOString().split('T')[0];
                });

                // Fetch logs for the last 7 days
                let logsQuery = supabase
                    .from('transaction_logs')
                    .select('created_at, type, metadata, profiles!transaction_logs_user_id_fkey!inner(client_code)')
                    .gte('created_at', last7Days[0]);

                if (cfg.code === 'mare_cafe') {
                    logsQuery = logsQuery.or('client_code.eq.mare_cafe,client_code.is.null', { foreignTable: 'profiles' });
                } else {
                    logsQuery = logsQuery.eq('profiles.client_code', cfg.code);
                }
                const { data: logs } = await logsQuery;

                let clientsQuery = supabase
                    .from('profiles')
                    .select('created_at')
                    .eq('role', 'customer')
                    .gte('created_at', last7Days[0]);

                if (cfg.code === 'mare_cafe') {
                    clientsQuery = clientsQuery.or('client_code.eq.mare_cafe,client_code.is.null');
                } else {
                    clientsQuery = clientsQuery.eq('client_code', cfg.code);
                }

                const { data: newClients } = await clientsQuery;

                const chartDataMap = last7Days.reduce((acc: any, date) => {
                    const dayName = new Date(date).toLocaleDateString('es-ES', { weekday: 'short' });
                    acc[date] = {
                        name: dayName.charAt(0).toUpperCase() + dayName.slice(1),
                        scans: 0,
                        redeems: 0,
                        newClients: 0
                    };
                    return acc;
                }, {});

                logs?.forEach(log => {
                    const date = log.created_at.split('T')[0];
                    if (chartDataMap[date]) {
                        if (log.type === 'add_stamp') chartDataMap[date].scans += 1;
                        if (log.type === 'redeem_reward') chartDataMap[date].redeems += 1;
                    }
                });

                newClients?.forEach(client => {
                    const date = client.created_at.split('T')[0];
                    if (chartDataMap[date]) {
                        chartDataMap[date].newClients += 1;
                    }
                });

                setChartData(Object.values(chartDataMap));
            };

            await fetchMetrics(config);
            await fetchCampaigns();
            await fetchChartData(config);
            setLoading(false);

            // Realtime Subscriptions
            const changes = supabase
                .channel('admin-dashboard-realtime')
                .on(
                    'postgres_changes',
                    { event: 'INSERT', schema: 'public', table: 'transaction_logs' },
                    (payload) => {
                        console.log('New transaction:', payload);
                        fetchMetrics(config);
                        fetchChartData(config);
                    }
                )
                .on(
                    'postgres_changes',
                    { event: 'INSERT', schema: 'public', table: 'profiles' },
                    (payload) => {
                        console.log('New profile:', payload);
                        fetchMetrics(config);
                    }
                )
                .subscribe();

            return () => {
                supabase.removeChannel(changes);
            };
        };
        init();
    }, [router, config]);

    const [isSending, setIsSending] = useState(false);
    const [activeAudience, setActiveAudience] = useState('Todos');
    const [showEditor, setShowEditor] = useState(false);
    const [editorInitialData, setEditorInitialData] = useState<any>({});

    // Templates State
    const [templates, setTemplates] = useState<string[]>([
        '/clients/mare_cafe/flyer_template_1_1769954037447.png',
        '/clients/mare_cafe/flyer_template_2_1769954052827.png',
        '/clients/mare_cafe/flyer_template_3_1769954068639.png'
    ]);

    const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const result = e.target?.result as string;
                setTemplates(prev => [...prev, result]);
            };
            reader.readAsDataURL(file);
        }
    };

    const openEditor = (templateUrl: string) => {
        setEditorInitialData({
            imageUrl: templateUrl,
            title: 'Â¡Novedades en Mare Cafe! â˜•ï¸',
            content: 'Tenemos nuevas promociones esperÃ¡ndote. Ven y disfruta de un momento especial.'
        });
        setShowEditor(true);
    };

    // Campaigns State
    const [campaigns, setCampaigns] = useState<any[]>([]);

    const fetchCampaigns = async () => {
        const { data } = await supabase.from('campaigns').select('*').order('created_at', { ascending: false });
        if (data) setCampaigns(data);
    };

    const handleSendFromEditor = async (data: { title: string; content: string; html: string; audience: string; imageUrl?: string }) => {
        if (!confirm('Â¿EstÃ¡s seguro de enviar esta campaÃ±a a ' + data.audience + '?')) return;

        setIsSending(true);

        try {
            // 1. Create Campaign in DB
            const { data: campaign, error } = await supabase.from('campaigns').insert({
                title: data.title,
                content: data.content,
                audience: data.audience,
                status: 'active',
                metadata: { imageUrl: data.imageUrl || '' } // Store image URL reference
            }).select().single();

            if (error) throw error;

            // 2. Send via Resend (Server Action)
            // Note: We might want to pass campaignId to the action to generate the dynamic QR link
            // For now, let's append campaignId to FormData so the action can incorporate it
            const formData = new FormData();
            formData.append('title', data.title);
            formData.append('content', data.content);
            formData.append('html', data.html);
            formData.append('audience', data.audience);
            formData.append('campaignId', campaign.id); // Valid UUID

            const { sendCampaign } = await import('../actions/marketing');
            const result = await sendCampaign(formData);

            if (result.success) {
                alert('âœ… ' + result.message);
                setShowEditor(false); // Close editor on success
                fetchCampaigns(); // Refresh list
            } else {
                alert('âŒ Error: ' + result.message);
                // Optional: rollback DB creation if email fails? Or just leave it as draft?
            }
        } catch (e: any) {
            alert('Error inesperado: ' + e.message);
            console.error(e);
        } finally {
            setIsSending(false);
        }
    };

    const toggleCampaignStatus = async (id: string, currentStatus: string) => {
        const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
        const { error } = await supabase.from('campaigns').update({ status: newStatus }).eq('id', id);

        if (error) {
            alert('Error cambiando estado');
        } else {
            // Optimistic update
            setCampaigns(prev => prev.map(c => c.id === id ? { ...c, status: newStatus } : c));
        }
    };

    // Keep legacy handle for the direct "Enviar CampaÃ±a" button if needed, 
    // or we can remove the old UI section. For now, let's keep the tool but disable the old button to force using the editor?
    // Actually the user wanted "que cuando se apreta 'usar' salga un editor".

    const handleSendCampaign = async () => {
        // This was the old direct send. Let's redirect to editor or keep as "Quick Send"
        // For now, let's just leave it but maybe we don't need it if we have the editor.
        // User said: "me gustaria que las 3 portadas... se puedan editar... o sale un editor"
        // So the main flow should be via templates.
        alert("Por favor selecciona un diseÃ±o para editar y enviar.");
    };

    const handleTestEmail = async () => {
        const email = prompt('Ingresa tu email para la prueba:', 'tu@email.com');
        if (!email) return;

        setIsSending(true);
        const formData = new FormData();
        formData.append('title', '[TEST] Vista Previa Mare Cafe');
        formData.append('content', 'Esta es una PRUEBA de visualizaciÃ³n del flyer.');
        formData.append('audience', 'Test');
        formData.append('testEmail', email);

        try {
            const { sendCampaign } = await import('../actions/marketing');
            const result = await sendCampaign(formData);
            alert(result.success ? 'âœ… ' + result.message : 'âŒ ' + result.message);
        } catch (e: any) {
            alert('Error: ' + e.message);
        } finally {
            setIsSending(false);
        }
    };

    const handleLogout = async () => {
        await supabase.auth.signOut();
        router.push('/');
    };

    if (loading) return <div className="flex h-screen items-center justify-center bg-gray-50 text-blue-900 font-bold animate-pulse">Cargando Panel...</div>;

    return (
        <main className="min-h-screen bg-gray-50 font-sans flex flex-col md:flex-row">

            {/* Sidebar Desktop / Mobile Header */}
            <aside className="md:w-64 bg-[#1E3A8A] text-white flex flex-col md:min-h-screen shadow-2xl z-20">
                <div className="p-6 flex items-center justify-center md:justify-start gap-4 border-b border-blue-800/50">
                    {config.assets?.logo ? (
                        <img
                            src={config.assets.logo}
                            alt="Logo"
                            className="h-56 w-auto object-contain"
                        />
                    ) : (
                        <>
                            <div className="w-8 h-8 bg-white rounded-full flex items-center justify-center">
                                <TrendingUp size={18} className="text-[#1E3A8A]" />
                            </div>
                            <div>
                                <h1 className="font-playfair font-bold text-lg tracking-wide">MARE CAFE</h1>
                                <p className="text-xs text-blue-200">Admin Control</p>
                            </div>
                        </>
                    )}
                </div>

                <nav className="flex-1 p-4 grid grid-cols-2 md:flex md:flex-col gap-2 md:gap-3 overflow-y-auto content-start">
                    <button onClick={() => setActiveTab('overview')} className={`flex flex-col md:flex-row items-center justify-center md:justify-start gap-1 md:gap-3 w-full p-2 md:p-3 rounded-xl transition-all duration-300 ${activeTab === 'overview' ? 'bg-white text-[#1E3A8A] font-bold shadow-lg' : 'text-blue-200 hover:bg-blue-800/50'}`}>
                        <TrendingUp size={18} /> <span className="whitespace-nowrap text-[10px] md:text-base">Resumen</span>
                    </button>
                    <button onClick={() => setActiveTab('clients')} className={`flex flex-col md:flex-row items-center justify-center md:justify-start gap-1 md:gap-3 w-full p-2 md:p-3 rounded-xl transition-all duration-300 ${activeTab === 'clients' ? 'bg-white text-[#1E3A8A] font-bold shadow-lg' : 'text-blue-200 hover:bg-blue-800/50'}`}>
                        <Users size={18} /> <span className="whitespace-nowrap text-[10px] md:text-base">Clientes</span>
                    </button>
                    <button onClick={() => setActiveTab('marketing')} className={`flex flex-col md:flex-row items-center justify-center md:justify-start gap-1 md:gap-3 w-full p-2 md:p-3 rounded-xl transition-all duration-300 ${activeTab === 'marketing' ? 'bg-white text-[#1E3A8A] font-bold shadow-lg' : 'text-blue-200 hover:bg-blue-800/50'}`}>
                        <Mail size={18} /> <span className="whitespace-nowrap text-[10px] md:text-base">Novedades</span>
                    </button>
                    <button onClick={() => setActiveTab('settings')} className={`flex flex-col md:flex-row items-center justify-center md:justify-start gap-1 md:gap-3 w-full p-2 md:p-3 rounded-xl transition-all duration-300 ${activeTab === 'settings' ? 'bg-white text-[#1E3A8A] font-bold shadow-lg' : 'text-blue-200 hover:bg-blue-800/50'}`}>
                        <Settings size={18} /> <span className="whitespace-nowrap text-[10px] md:text-base">Ajustes</span>
                    </button>
                    <button onClick={() => router.push('/staff')} className="flex flex-col md:flex-row items-center justify-center md:justify-start gap-1 md:gap-3 w-full p-2 md:p-3 rounded-xl text-emerald-300 hover:bg-emerald-900/20 transition-all font-semibold">
                        <Scan size={18} /> <span className="whitespace-nowrap text-[10px] md:text-base">EscÃ¡ner</span>
                    </button>
                    <button onClick={handleLogout} className="flex flex-col md:flex-row items-center justify-center md:justify-start gap-1 md:gap-3 w-full p-2 md:p-3 rounded-xl text-red-300 hover:bg-red-900/20 transition-all">
                        <LogOut size={18} /> <span className="whitespace-nowrap text-[10px] md:text-base">Salir</span>
                    </button>

                    {/* Activity tab - only visible on desktop */}
                    <button onClick={() => setActiveTab('activity')} className={`hidden md:flex flex-row items-center justify-start gap-3 w-full p-3 rounded-xl transition-all duration-300 ${activeTab === 'activity' ? 'bg-white text-[#1E3A8A] font-bold shadow-lg' : 'text-blue-200 hover:bg-blue-800/50'}`}>
                        <Clock size={20} /> <span className="whitespace-nowrap text-base">Actividad</span>
                    </button>

                    <div className="hidden md:block mt-auto pb-4">
                        <PoweredBy />
                    </div>
                </nav>
            </aside>

            {/* Main Content */}
            <div className="flex-1 overflow-y-auto h-[calc(100vh-80px)] md:h-screen bg-[#F8FAFC]">
                <header className="bg-white p-6 shadow-sm flex justify-between items-center sticky top-0 z-10 backdrop-blur-md bg-white/80">
                    <h2 className="text-2xl font-bold text-slate-800">
                        {activeTab === 'overview' && 'Hola, Admin ðŸ‘‹'}
                        {activeTab === 'clients' && 'Base de Datos de Clientes ðŸ‘¥'}
                        {activeTab === 'marketing' && 'Novedades y Eventos ðŸ“¨'}
                        {activeTab === 'settings' && 'ConfiguraciÃ³n del Local âš™ï¸'}
                    </h2>
                    <div className="flex gap-4">
                        <button className="relative p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition">
                            <Bell size={20} className="text-slate-600" />
                            <span className="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
                        </button>
                    </div>
                </header>

                <div className="p-4 md:p-8 space-y-6 md:space-y-8 max-w-7xl mx-auto">

                    {/* OVERVIEW TAB */}
                    {activeTab === 'overview' && (
                        <div className="space-y-8 animate-in fade-in duration-500">
                            {/* Key Metrics */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <MetricCard
                                    title="Clientes Totales"
                                    value={metrics.totalClients}
                                    icon={<Users size={24} />}
                                    color="bg-blue-500"
                                    trend="+12% este mes"
                                    isActive={activeChart === 'clients'}
                                    onClick={() => setActiveChart('clients')}
                                />
                                <MetricCard
                                    title="Visitas Hoy"
                                    value={metrics.scansToday}
                                    icon={<Scan size={24} />}
                                    color="bg-emerald-500"
                                    trend="En vivo"
                                    isActive={activeChart === 'scans'}
                                    onClick={() => setActiveChart('scans')}
                                />
                                <MetricCard
                                    title="Premios Dados"
                                    value={metrics.redemptionsTotal}
                                    icon={<Gift size={24} />}
                                    color="bg-purple-500"
                                    trend="Fidelidad alta"
                                    isActive={activeChart === 'redemptions'}
                                    onClick={() => setActiveChart('redemptions')}
                                />
                            </div>

                            {/* Chart Section */}
                            <div className="bg-white p-6 rounded-3xl shadow-lg border border-slate-100 transition-all">
                                <div className="flex justify-between items-end mb-6">
                                    <div>
                                        <h3 className="text-lg font-bold text-slate-800">
                                            {activeChart === 'scans' && 'Tendencia de Escaneos'}
                                            {activeChart === 'clients' && 'Crecimiento de Clientes'}
                                            {activeChart === 'redemptions' && 'Historial de Canjes'}
                                        </h3>
                                        <p className="text-slate-400 text-sm">
                                            {activeChart === 'scans' && 'Actividad de visitas diarias.'}
                                            {activeChart === 'clients' && 'Nuevos registros en la plataforma.'}
                                            {activeChart === 'redemptions' && 'Premios entregados por el staff.'}
                                        </p>
                                    </div>
                                    <div className="flex gap-2 text-sm">
                                        <span className="font-semibold text-slate-500 px-3 py-1 bg-slate-100 rounded-full">Ãšltimos 7 dÃ­as</span>
                                    </div>
                                </div>
                                <div className="h-[300px] w-full">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <AreaChart data={chartData}>
                                            <defs>
                                                <linearGradient id="colorMain" x1="0" y1="0" x2="0" y2="1">
                                                    <stop offset="5%" stopColor={activeChart === 'scans' ? '#1E3A8A' : activeChart === 'redemptions' ? '#8B5CF6' : '#3B82F6'} stopOpacity={0.3} />
                                                    <stop offset="95%" stopColor={activeChart === 'scans' ? '#1E3A8A' : activeChart === 'redemptions' ? '#8B5CF6' : '#3B82F6'} stopOpacity={0} />
                                                </linearGradient>
                                            </defs>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#E2E8F0" />
                                            <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{ fill: '#94A3B8' }} />
                                            <Tooltip
                                                contentStyle={{ borderRadius: '12px', border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.1)' }}
                                                formatter={(value, name) => {
                                                    if (name === 'scans') return [value, 'Escaneos'];
                                                    if (name === 'redeems') return [value, 'Canjes'];
                                                    if (name === 'newClients') return [value, 'Nuevos Clientes'];
                                                    return [value, name];
                                                }}
                                                labelFormatter={(label) => `ðŸ“… ${label}`}
                                            />
                                            {/* Conditionally render Areas based on activeChart */}
                                            {activeChart === 'scans' && (
                                                <Area type="monotone" dataKey="scans" stroke="#1E3A8A" strokeWidth={3} fillOpacity={1} fill="url(#colorMain)" animationDuration={1000} />
                                            )}
                                            {activeChart === 'redemptions' && (
                                                <Area type="monotone" dataKey="redeems" stroke="#8B5CF6" strokeWidth={3} fillOpacity={1} fill="url(#colorMain)" animationDuration={1000} />
                                            )}
                                            {activeChart === 'clients' && (
                                                <Area type="monotone" dataKey="newClients" stroke="#3B82F6" strokeWidth={3} fillOpacity={1} fill="url(#colorMain)" animationDuration={1000} />
                                            )}
                                        </AreaChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* CLIENTS TAB (NEW) */}
                    {activeTab === 'clients' && (
                        <ClientsTab />
                    )}

                    {/* MARKETING TAB */}
                    {activeTab === 'marketing' && (
                        <div className="space-y-8 animate-in slide-in-from-right-4 duration-500">

                            {/* Campaign Creator */}
                            <div className="grid grid-cols-1 xl:grid-cols-3 gap-8">

                                <div className="xl:col-span-2 space-y-6">
                                    <div className="bg-white p-6 rounded-3xl shadow-lg border border-slate-100">
                                        <h3 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                                            <Send size={24} className="text-blue-600" /> Nueva CampaÃ±a
                                        </h3>

                                        <div className="space-y-6">
                                            {/* Audience */}
                                            <div>
                                                <label className="text-sm font-semibold text-slate-600 mb-2 block">Audiencia Objetivo</label>
                                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                                    {['Todos', 'Nivel 2+ (Frecuentes)', 'Nivel 3+ (VIP)'].map((label) => (
                                                        <button
                                                            key={label}
                                                            onClick={() => setActiveAudience(label)}
                                                            className={`py-2 px-4 rounded-xl border text-sm font-medium transition-all ${activeAudience === label ? 'bg-blue-50 border-blue-500 text-blue-700 ring-2 ring-blue-200' : 'border-slate-200 text-slate-600 hover:bg-slate-50'}`}
                                                        >
                                                            {label}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>

                                            {/* Template Selection */}
                                            <div>
                                                <div className="flex justify-between items-center mb-2">
                                                    <label className="text-sm font-semibold text-slate-600 block">Selecciona un DiseÃ±o (Flyer)</label>
                                                    <label className="cursor-pointer text-xs font-bold text-blue-600 hover:bg-blue-50 px-3 py-1 rounded-full border border-blue-200 flex items-center gap-1 transition">
                                                        <Plus size={14} /> Subir Propia
                                                        <input type="file" className="hidden" accept="image/*" onChange={handleFileUpload} />
                                                    </label>
                                                </div>
                                                {/* Use key to force re-render if needed, but here simple mapping is fine. */}
                                                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                                    {templates.map((src, idx) => (
                                                        <div key={idx} className="relative aspect-[3/4] rounded-xl overflow-hidden cursor-pointer group border-2 border-transparent hover:border-blue-500 transition-all">
                                                            <img src={src} alt={`Template ${idx}`} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" />
                                                            <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                                                <button
                                                                    onClick={() => openEditor(src)}
                                                                    className="bg-white text-blue-900 text-xs font-bold px-3 py-1 rounded-full hover:scale-105 transition"
                                                                >
                                                                    Usar / Editar
                                                                </button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>

                                            {/* AI Smart Edit - Keeping as placeholder/beta */}
                                            <div className="bg-slate-50 p-4 rounded-2xl border border-slate-200 opacity-60 pointer-events-none">
                                                <div className="flex items-center justify-between mb-3">
                                                    <h4 className="font-bold text-slate-700 text-sm flex items-center gap-2">âœ¨ Agente de Marketing (PrÃ³ximamente)</h4>
                                                </div>
                                                <p className="text-xs text-slate-400">La IA generarÃ¡ textos y ofertas automÃ¡ticamente en la prÃ³xima versiÃ³n.</p>
                                            </div>

                                            <button
                                                onClick={handleTestEmail}
                                                className="w-full bg-slate-100 text-slate-600 py-2 rounded-xl font-semibold text-sm hover:bg-slate-200 transition"
                                            >
                                                ðŸ§ª Enviar Prueba RÃ¡pida (Sin Editor)
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* History & Metrics */}
                                <div className="space-y-6">
                                    <div className="bg-white p-6 rounded-3xl shadow-lg border border-slate-100 h-full overflow-y-auto max-h-[800px]">
                                        <h3 className="font-bold text-slate-800 mb-6">Historial de EnvÃ­os</h3>
                                        <div className="space-y-6">
                                            {campaigns.length === 0 && (
                                                <div className="text-center text-slate-400 text-sm py-4">No hay campaÃ±as enviadas aÃºn.</div>
                                            )}
                                            {campaigns.map((camp) => (
                                                <div key={camp.id} className="group border-b border-slate-50 pb-4 last:border-0">
                                                    <div className="relative aspect-video rounded-xl overflow-hidden mb-3 bg-gray-100 flex items-center justify-center border border-slate-100">
                                                        {/* We can store image URL in metadata if we want to show it here later. For now placeholder or generic icon */}
                                                        {camp.metadata?.imageUrl ? (
                                                            <img src={camp.metadata.imageUrl} className="w-full h-full object-cover" />
                                                        ) : (
                                                            <Mail className="text-slate-300" size={32} />
                                                        )}
                                                        <div className="absolute top-2 right-2">
                                                            <span className={`px-2 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider ${camp.status === 'active' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-500'}`}>
                                                                {camp.status === 'active' ? 'Activa' : 'Inactiva'}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <h4 className="font-bold text-slate-800 text-sm truncate">{camp.title}</h4>
                                                    <div className="flex justify-between items-center mt-2 text-xs text-slate-500">
                                                        <span>{new Date(camp.created_at).toLocaleDateString()}</span>
                                                        <label className="relative inline-flex items-center cursor-pointer">
                                                            <input
                                                                type="checkbox"
                                                                checked={camp.status === 'active'}
                                                                onChange={() => toggleCampaignStatus(camp.id, camp.status)}
                                                                className="sr-only peer"
                                                            />
                                                            <div className="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                                                        </label>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    )}

                    {/* STAFF ACTIVITY TAB */}
                    {activeTab === 'activity' && (
                        <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
                            <div className="bg-white p-6 rounded-3xl shadow-md border border-slate-100">
                                <h3 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                                    <Scan size={24} className="text-blue-600" /> Registro de Actividad
                                </h3>

                                <div className="overflow-x-auto">
                                    <table className="w-full text-left border-collapse">
                                        <thead>
                                            <tr className="border-b border-slate-100 text-slate-400 text-xs uppercase tracking-wider">
                                                <th className="p-4 font-semibold">Fecha y Hora</th>
                                                <th className="p-4 font-semibold">Staff (Simulado)</th>
                                                <th className="p-4 font-semibold">AcciÃ³n</th>
                                                <th className="p-4 font-semibold">Cliente</th>
                                            </tr>
                                        </thead>
                                        <tbody className="text-slate-600 text-sm">
                                            {/* In a real app, map through 'logs' state */}
                                            <tr className="border-b border-slate-50 hover:bg-slate-50 transition">
                                                <td className="p-4">Hoy, 10:42 AM</td>
                                                <td className="p-4 font-medium text-slate-800">Camarero 1</td>
                                                <td className="p-4"><span className="bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full text-xs font-bold">Escaneo</span></td>
                                                <td className="p-4">juan.perez@gmail.com</td>
                                            </tr>
                                            <tr className="border-b border-slate-50 hover:bg-slate-50 transition">
                                                <td className="p-4">Hoy, 09:15 AM</td>
                                                <td className="p-4 font-medium text-slate-800">Admin (TÃº)</td>
                                                <td className="p-4"><span className="bg-purple-100 text-purple-700 px-2 py-1 rounded-full text-xs font-bold">Canje Premio</span></td>
                                                <td className="p-4">maria.gomez@hotmail.com</td>
                                            </tr>
                                            <tr className="border-b border-slate-50 hover:bg-slate-50 transition">
                                                <td className="p-4">Ayer, 18:30 PM</td>
                                                <td className="p-4 font-medium text-slate-800">Camarero 2</td>
                                                <td className="p-4"><span className="bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full text-xs font-bold">Escaneo</span></td>
                                                <td className="p-4">carlos.lopez@yahoo.com</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div className="mt-4 text-center">
                                    <p className="text-xs text-slate-400">Mostrando Ãºltimos 3 movimientos.</p>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* SETTINGS TAB */}
                    {activeTab === 'settings' && (
                        <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="bg-white p-6 rounded-3xl shadow-md border border-slate-100">
                                    <h3 className="text-lg font-bold text-slate-800 mb-6 border-b pb-2">Reglas de Negocio</h3>
                                    <div className="space-y-6">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <h4 className="font-semibold text-slate-700">Happy Hour (Puntos Dobles)</h4>
                                                <p className="text-xs text-slate-400">Los clientes suman x2 sellos al escanear.</p>
                                            </div>
                                            <label className="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" value="" className="sr-only peer" />
                                                <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                            </label>
                                        </div>
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <h4 className="font-semibold text-slate-700">Solicitar PIN en Canjes</h4>
                                                <p className="text-xs text-slate-400">Mayor seguridad al entregar premios.</p>
                                            </div>
                                            <label className="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" value="" className="sr-only peer" defaultChecked />
                                                <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                            </label>
                                        </div>
                                    </div>
                                </div>


                                <div className="bg-white p-6 rounded-3xl shadow-md border border-slate-100">
                                    <h3 className="text-lg font-bold text-slate-800 mb-6 border-b pb-2">Credenciales</h3>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="text-sm font-semibold text-slate-600">PIN Maestro (Admin)</label>
                                            <div className="flex gap-2">
                                                <input type="password" value="MARE-ADMIN-2024" disabled className="w-full mt-1 p-2 bg-slate-50 text-slate-500 rounded-lg border border-slate-200" />
                                            </div>
                                            <p className="text-xs text-orange-500 mt-1">Este PIN permite crear nuevos administradores.</p>
                                        </div>
                                        <button className="w-full py-3 rounded-xl bg-slate-900 text-white font-bold hover:bg-slate-800 transition">
                                            Actualizar Credenciales
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            </div>
            {showEditor && (
                <EmailEditor
                    initialData={editorInitialData}
                    onClose={() => setShowEditor(false)}
                    onSend={handleSendFromEditor}
                    audience={activeAudience}
                    isSending={isSending}
                />
            )}
        </main>
    );
}

function MetricCard({ title, value, icon, color, trend, isActive, onClick }: any) {
    return (
        <div
            onClick={onClick}
            className={`bg-white p-5 rounded-3xl shadow-lg border transition-all cursor-pointer flex items-center gap-4 hover:scale-[1.02] ${isActive ? 'border-blue-500 ring-4 ring-blue-50/50' : 'border-slate-50'}`}
        >
            <div className={`p-4 rounded-2xl text-white shadow-md ${color}`}>
                {icon}
            </div>
            <div>
                <p className="text-slate-400 text-xs font-bold uppercase tracking-wider">{title}</p>
                <div className="flex items-baseline gap-2">
                    <h3 className="text-3xl font-black text-slate-800">{value}</h3>
                </div>
                <p className="text-xs font-medium text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-md inline-block mt-1">
                    {trend}
                </p>
            </div>
            {isActive && <div className="ml-auto w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>}
        </div>
    );
}
</file>

<file path="src/app/auth/login/page.tsx">
'use client';

import { Suspense, useEffect, useState } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';
import { useClientConfig } from '@/context/ClientConfigContext';
import { supabase } from '@/lib/supabase';
import { ArrowLeft, Loader2, Store, User } from 'lucide-react';
import PoweredBy from '@/components/PoweredBy';
import Link from 'next/link';

function AuthContent() {
    const params = useSearchParams();
    const router = useRouter();
    const config = useClientConfig();

    const role = params.get('role') as 'customer' | 'staff' | null;
    const [isLogin, setIsLogin] = useState(true);
    const [loading, setLoading] = useState(false);

    // Form State
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [fullName, setFullName] = useState('');
    const [shopPin, setShopPin] = useState(''); // Only for staff registration

    // Validation / Error
    const [error, setError] = useState<string | null>(null);

    // If no role specified, redirect to landing
    useEffect(() => {
        if (!role || !['customer', 'staff'].includes(role)) {
            router.push('/');
        }
    }, [role, router]);

    if (!role) return null;

    const handleAuth = async (e: React.FormEvent) => {
        e.preventDefault();
        setLoading(true);
        setError(null);

        try {
            if (isLogin) {
                // --- LOGIN FLOW ---
                const { data, error: signInError } = await supabase.auth.signInWithPassword({
                    email,
                    password,
                });

                if (signInError) throw signInError;

                // Check if user has the correct role AND correct client
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('role, client_code') // Fetch client_code
                    .eq('id', data.user.id)
                    .single();

                // 1. Role Check
                if (profile?.role !== role && profile?.role !== 'admin') {
                    throw new Error(`Este usuario no estÃ¡ registrado como ${role === 'customer' ? 'Cliente' : 'Staff'}.`);
                }

                // 2. Client Isolation Check
                // STRICT RULE for Perezoso: Must match exactly.
                if (config.code === 'perezoso_cafe') {
                    if (profile?.client_code !== 'perezoso_cafe' && profile?.role !== 'admin') {
                        throw new Error(`Esta cuenta no estÃ¡ registrada en Perezoso Cafe.`);
                    }
                }
                // LEGACY RULE for Mare: Allow 'mare_cafe' OR null (old users)
                else if (config.code === 'mare_cafe') {
                    if (profile?.client_code && profile.client_code !== 'mare_cafe' && profile?.role !== 'admin') {
                        throw new Error(`Esta cuenta pertenece a otro comercio.`);
                    }
                }
                // GENERIC: fallback
                else {
                    if (profile?.client_code && profile.client_code !== config.code && profile?.role !== 'admin') {
                        throw new Error(`Esta cuenta no pertenece a ${config.name}.`);
                    }
                }

                // If profile has NO client_code, we effectively treat it as "Global" or "Legacy Mare".
                // To force strictness, we could say: if (!profile.client_code && config.code !== 'mare_cafe') throw Error...
                // But let's stick to positive match if present for now to avoid locking out existing dev users.

                // Redirect based on role
                if (role === 'customer') router.push('/client');
                else if (profile?.role === 'admin') router.push('/admin');
                else router.push('/staff');

            } else {
                // --- SIGN UP FLOW ---

                // ... (PIN logic remains same) ...

                // 1. PIN Verification & Role Assignment
                let finalRole: 'customer' | 'staff' | 'admin' | null = role;

                if (role === 'staff') {
                    // SECURE PIN VERIFICATION
                    const { data: verification, error: verifyError } = await supabase
                        .rpc('verify_shop_pin', { input_pin: shopPin, shop_code: config.code });

                    if (verifyError || !verification?.valid) {
                        throw new Error('PIN de tienda invÃ¡lido.');
                    }

                    finalRole = verification.role === 'admin' ? 'admin' : 'staff';
                }

                // 2. Create Auth User
                const { data, error: signUpError } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            full_name: fullName,
                            role: finalRole,
                            client_code: config.code, // Save client code in auth metadata too
                        }
                    }
                });

                if (signUpError) throw signUpError;

                // 3. Create Profile Entry manually
                if (data.user) {
                    const { error: profileError } = await supabase.from('profiles').insert({
                        id: data.user.id,
                        email: email,
                        role: finalRole,
                        full_name: fullName,
                        client_code: config.code, // IMPORTANT: Associate user with THIS client
                    });
                    if (profileError) console.error("Profile creation warning:", profileError);
                }

                alert('Registro exitoso. Â¡Por favor inicia sesiÃ³n!');
                setIsLogin(true); // Switch to login views
            }
        } catch (err: any) {
            setError(err.message || 'OcurriÃ³ un error desconocido');
        } finally {
            setLoading(false);
        }
    };

    const isCustomer = role === 'customer';

    return (
        <div className="flex min-h-screen bg-white">
            {/* Left Panel - Branding (Desktop) */}
            <div className="hidden lg:flex w-1/2 items-center justify-center p-12 relative overflow-hidden"
                style={{ backgroundColor: config.theme.primaryColor }}>
                <div className="absolute inset-0 opacity-20" style={{
                    backgroundImage: 'url("https://www.transparenttextures.com/patterns/cubes.png")',
                }}></div>

                <div className="text-center text-white space-y-8 z-10 relative">
                    {config.assets?.logo ? (
                        <img
                            src={config.assets.logo}
                            alt={config.name}
                            className="w-64 mx-auto drop-shadow-2xl hover:scale-105 transition duration-700"
                        />
                    ) : (
                        isCustomer ? <User size={100} className="mx-auto" /> : <Store size={100} className="mx-auto" />
                    )}

                    <div className="space-y-4 max-w-lg mx-auto">
                        <h2 className="text-5xl font-playfair font-bold tracking-wide">
                            {isLogin ? 'Bienvenido' : 'Ãšnete a la Familia'}
                        </h2>
                        <p className="text-xl text-blue-100 font-light leading-relaxed">
                            {isCustomer
                                ? 'La excelencia del cafÃ© de especialidad, ahora premia tu fidelidad.'
                                : 'Plataforma administrativa para el mejor equipo.'}
                        </p>
                    </div>
                </div>
            </div>

            {/* Right Panel - Form */}
            <div className="flex-1 flex flex-col justify-center p-8 sm:p-20 bg-white relative">
                <div className="absolute inset-0 lg:hidden opacity-5 pointer-events-none" style={{ backgroundColor: config.theme.primaryColor }}></div>

                <div className="max-w-md mx-auto w-full space-y-8 relative z-10">
                    <Link href="/" className="text-slate-400 hover:text-slate-600 flex items-center gap-2 transition group inline-flex mb-4">
                        <ArrowLeft size={18} className="group-hover:-translate-x-1 transition-transform" />
                        <span className="font-medium text-sm">Volver al inicio</span>
                    </Link>

                    <div className="text-center lg:text-left space-y-4">
                        {/* Mobile Logo */}
                        <div className="lg:hidden flex justify-center mb-6">
                            {config.assets?.logo ? (
                                <img
                                    src={config.assets.logo}
                                    alt={config.name}
                                    className="w-32 drop-shadow-lg"
                                />
                            ) : null}
                        </div>

                        <h1 className="text-4xl font-bold text-slate-900 font-playfair leading-tight">
                            {isCustomer ? (isLogin ? 'Acceso Clientes' : 'Crear Cuenta') : 'Acceso Staff'}
                        </h1>
                        <p className="text-slate-500">
                            {isLogin ? 'Ingresa tus datos para continuar.' : 'Completa el formulario para empezar a sumar puntos.'}
                        </p>
                    </div>

                    {error && (
                        <div className="p-4 bg-red-50 text-red-600 rounded-xl text-sm border border-red-100 flex items-center gap-2 animate-in slide-in-from-top-2">
                            <span className="font-bold">Error:</span> {error}
                        </div>
                    )}

                    <form onSubmit={handleAuth} className="space-y-5">
                        {!isLogin && (
                            <div className="space-y-5 animate-in slide-in-from-bottom-4 duration-500">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Nombre Completo</label>
                                    <input
                                        type="text"
                                        required
                                        placeholder="Ej. Juan PÃ©rez"
                                        value={fullName}
                                        onChange={(e) => setFullName(e.target.value)}
                                        className="w-full rounded-xl border-slate-200 bg-slate-50 px-4 py-3 text-slate-900 focus:ring-2 focus:ring-blue-900 focus:bg-white transition-all outline-none"
                                    />
                                </div>
                                {role === 'staff' && (
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">PIN DE ACCESO</label>
                                        <input
                                            type="password"
                                            required
                                            value={shopPin}
                                            placeholder="â€¢â€¢â€¢â€¢"
                                            onChange={(e) => setShopPin(e.target.value)}
                                            className="w-full rounded-xl border-slate-200 bg-slate-50 px-4 py-3 text-slate-900 focus:ring-2 focus:ring-blue-900 focus:bg-white transition-all outline-none tracking-widest"
                                        />
                                    </div>
                                )}
                            </div>
                        )}

                        <div className="space-y-5">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Email</label>
                                <input
                                    type="email"
                                    required
                                    placeholder="tu@email.com"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full rounded-xl border-slate-200 bg-slate-50 px-4 py-3 text-slate-900 focus:ring-2 focus:ring-blue-900 focus:bg-white transition-all outline-none"
                                />
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">ContraseÃ±a</label>
                                <input
                                    type="password"
                                    required
                                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full rounded-xl border-slate-200 bg-slate-50 px-4 py-3 text-slate-900 focus:ring-2 focus:ring-blue-900 focus:bg-white transition-all outline-none"
                                />
                            </div>
                        </div>

                        <div className="pt-4">
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full py-4 rounded-xl shadow-xl text-sm font-bold text-white transition-all hover:scale-[1.02] active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2"
                                style={{ backgroundColor: config.theme.primaryColor }}
                            >
                                {loading ? <Loader2 className="animate-spin" /> : (isLogin ? 'INGRESAR' : 'CREAR CUENTA')}
                            </button>
                        </div>
                    </form>

                    <div className="text-center pt-4 border-t border-slate-100">
                        <p className="text-slate-500 text-sm mb-3">
                            {isLogin ? 'Â¿Primera vez aquÃ­?' : 'Â¿Ya tienes una cuenta?'}
                        </p>
                        <button
                            onClick={() => setIsLogin(!isLogin)}
                            className="text-sm font-bold hover:underline transition-all"
                            style={{ color: config.theme.primaryColor }}
                        >
                            {isLogin ? 'RegÃ­strate Gratis' : 'Inicia SesiÃ³n'}
                        </button>
                    </div>
                </div>

                <div className="pb-4 mt-auto">
                    <PoweredBy />
                </div>
            </div >
        </div >

    );
}

export default function LoginPage() {
    return (
        <Suspense fallback={<div className="min-h-screen flex items-center justify-center">Cargando...</div>}>
            <AuthContent />
        </Suspense>
    )
}
</file>

<file path="src/app/client/menu/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useClientConfig } from '@/context/ClientConfigContext';
import { CATEGORIES, PRODUCTS } from '@/data/menu-data';
import { Product } from '@/types/menu';

import MenuHeader from '@/components/client/menu/MenuHeader';
import CategoryTabs from '@/components/client/menu/CategoryTabs';
import ProductGrid from '@/components/client/menu/ProductGrid';
import ProductDetailModal from '@/components/client/menu/ProductDetailModal';

export default function MenuPage() {
    const router = useRouter();
    const config = useClientConfig();
    const [loading, setLoading] = useState(true);
    const [selectedCategory, setSelectedCategory] = useState('all');
    const [selectedProduct, setSelectedProduct] = useState<Product | null>(null);

    useEffect(() => {
        if (!config.features.menuEnabled) {
            router.replace('/client'); // Redirect if disabled
            return;
        }
        setLoading(false);
    }, [router, config]);

    const filteredProducts = selectedCategory === 'all'
        ? PRODUCTS
        : PRODUCTS.filter(p => p.category === selectedCategory);

    if (loading) return <div className="min-h-screen bg-white flex items-center justify-center">Cargando menÃº...</div>;

    return (
        <div className="min-h-screen bg-gray-50 pb-12">
            <MenuHeader title="Nuestro MenÃº" />

            <CategoryTabs
                categories={CATEGORIES}
                selectedCategory={selectedCategory}
                onSelect={setSelectedCategory}
            />

            <main className="max-w-2xl mx-auto mt-4">
                <ProductGrid
                    products={filteredProducts}
                    onProductClick={setSelectedProduct}
                />
            </main>

            <ProductDetailModal
                product={selectedProduct}
                onClose={() => setSelectedProduct(null)}
            />
        </div>
    );
}
</file>

<file path="src/app/client/page.tsx">
'use client';

import { useEffect, useState, useRef } from 'react';
import { useRouter } from 'next/navigation';
import { useClientConfig } from '@/context/ClientConfigContext';
import { ClientConfig } from '@/config/types';
import PoweredBy from '@/components/PoweredBy';
import { Coffee, Crown, Sparkles } from 'lucide-react';
import { supabase } from '@/lib/supabase';
import NewsFeed from '@/components/client/NewsFeed';

// New Components
import ClientHeader from '@/components/client/ClientHeader';
import WelcomeHero from '@/components/client/WelcomeHero';
import StampProgress from '@/components/client/StampProgress';
import RewardsCard from '@/components/client/RewardsCard';
import MenuButton from '@/components/client/MenuButton';
import QRFloatingButton from '@/components/client/QRFloatingButton';
import QRModal from '@/components/client/QRModal';
import AboutUs from '@/components/client/AboutUs';

export default function ClientDashboard() {
  const router = useRouter();
  const config = useClientConfig();
  const [stamps, setStamps] = useState<number>(0);
  const [level, setLevel] = useState<number>(1);
  const [userName, setUserName] = useState<string>('');
  const [loading, setLoading] = useState(true);
  const [userUUID, setUserUUID] = useState<string | null>(null);

  // UI States
  const [showQRModal, setShowQRModal] = useState(false);
  const [showLevelUpModal, setShowLevelUpModal] = useState(false);
  const [favDrink, setFavDrink] = useState('');

  // Polling Ref
  const pollingRef = useRef<NodeJS.Timeout | null>(null);

  useEffect(() => {
    const init = async () => {
      // Config from Context
      const { data: { user } } = await supabase.auth.getUser();

      if (!user) {
        router.push('/auth/login?role=customer');
        return;
      }

      // 1. Validate Client Isolation
      const { data: profile } = await supabase.from('profiles').select('client_code').eq('id', user.id).single();

      let isValidUser = true;

      if (config.code === 'perezoso_cafe') {
        // Perezoso requires strict match
        if (profile?.client_code !== 'perezoso_cafe') isValidUser = false;
      } else if (config.code === 'mare_cafe') {
        // Mare allows null (legacy) or match
        if (profile?.client_code && profile.client_code !== 'mare_cafe') isValidUser = false;
      } else {
        // Default strict if code present
        if (profile?.client_code && profile.client_code !== config.code) isValidUser = false;
      }

      if (!isValidUser) {
        await supabase.auth.signOut();
        alert(`Tu cuenta no pertenece a ${config.name}.`);
        router.push('/');
        return;
      }

      setUserUUID(user.id);
      await fetchData(user.id);
      setLoading(false);
    };

    init();

    return () => {
      if (pollingRef.current) clearInterval(pollingRef.current);
    };
  }, [router, config]);

  // Polling Logic: Watch for Redemption or Stamps update when QR is open
  useEffect(() => {
    if (showQRModal) {
      pollingRef.current = setInterval(async () => {
        if (userUUID) {
          const { data } = await supabase.from('stamps').select('count').eq('user_id', userUUID).single();
          if (data) {
            // Check if stamps dropped (redemption)
            if (stamps >= 7 && data.count < 7) {
              // Assuming 7 is the threshold, but should use config.rules.stampsPerReward ideally. 
              // However config might be null here if not careful, but useEffect dep array handles updates? 
              // Let's use current stamps state vs new data.
              // Actually, improved logic:
              setShowQRModal(false);
              setShowLevelUpModal(true);
            }

            // Always update stamps to show real-time progress if they just got a stamp
            if (data.count !== stamps) {
              setStamps(data.count);
            }
          }
        }
      }, 3000); // Check every 3s
    } else {
      if (pollingRef.current) clearInterval(pollingRef.current);
    }

    return () => {
      if (pollingRef.current) clearInterval(pollingRef.current);
    };
  }, [showQRModal, userUUID, stamps]); // Added stamps to dependency

  const fetchData = async (uuid: string) => {
    // 1. Stamps
    const { data: stampData } = await supabase.from('stamps').select('count').eq('user_id', uuid).single();
    if (stampData) setStamps(stampData.count);

    // 2. Profile (Level + Name)
    const { data: profileData } = await supabase.from('profiles').select('level, preferences, first_name').eq('id', uuid).single();
    if (profileData) {
      setLevel(profileData.level || 1);
      if (profileData.first_name) setUserName(profileData.first_name);
    }
  };

  const handleSavePreferences = async () => {
    if (!userUUID || !favDrink) return;

    await supabase.from('profiles').update({
      preferences: { favorite_drink: favDrink }
    }).eq('id', userUUID);

    setShowLevelUpModal(false);
    alert('Â¡Gracias! Guardamos tu preferencia.');
  };

  const handleLogout = async () => {
    await supabase.auth.signOut();
    router.push('/');
  };

  if (loading) return <div className="flex h-screen items-center justify-center">Cargando...</div>;

  const isRewardReady = stamps >= config.rules.stampsPerReward;

  return (
    <main
      className="min-h-screen flex flex-col font-sans transition-colors duration-500"
      style={{
        backgroundColor: config.theme.secondaryColor,
        color: config.theme.primaryColor,
      }}
    >
      <ClientHeader
        config={config}
        level={level}
        onLogout={handleLogout}
        showGoldQR={showQRModal && isRewardReady} // Pass this to style header if needed, though header might not need to change color anymore?
      // Actually, the new design keeps the header simple. Let's see ClientHeader props.
      // It accepts showGoldQR. If true, it turns black/gold.
      />

      <div className="flex-1 max-w-md md:max-w-xl lg:max-w-2xl mx-auto w-full p-4 md:p-6 pt-56 md:pt-60 flex flex-col gap-6 md:gap-8 pb-24">

        {/* Hero Section */}
        <WelcomeHero
          config={config}
          userName={userName}
          showGoldQR={false} // Always false in main view now
        />

        {/* Progress Section */}
        <StampProgress config={config} stamps={stamps} />

        {/* Reward CTA */}
        <RewardsCard
          config={config}
          isRewardReady={isRewardReady}
          onOpenQR={() => setShowQRModal(true)}
        />

        {/* Menu CTA */}
        <MenuButton config={config} />

        {/* News Feed */}
        {config.features.showNewsFeed && <NewsFeed />}

        {/* About Us */}
        <AboutUs config={config} />

      </div>

      {/* Floating Action Button */}
      <QRFloatingButton
        onClick={() => setShowQRModal(true)}
        primaryColor={config.theme.primaryColor}
      />

      {/* QR Modal (Bottom Sheet) */}
      <QRModal
        isOpen={showQRModal}
        onClose={() => setShowQRModal(false)}
        userUUID={userUUID}
        isRewardReady={isRewardReady}
        config={config}
      />

      {/* Level Up / Reward Claimed Modal */}
      {showLevelUpModal && (
        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-300">
          <div className="bg-white rounded-3xl p-8 max-w-sm w-full text-center space-y-6">
            <div className="w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce">
              <Crown size={40} className="text-amber-500" />
            </div>

            <div>
              <h2 className="text-2xl font-bold text-gray-800">Â¡Nivel {level} Desbloqueado! ðŸš€</h2>
              <p className="text-gray-500 mt-2">Se nota que te gusta lo que hacemos. Gracias por elegirnos.</p>
            </div>

            <div className="bg-gray-50 p-4 rounded-xl text-left border border-gray-200">
              <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                <Coffee size={16} /> Â¿CuÃ¡l es tu bebida favorita?
              </label>
              <input
                type="text"
                value={favDrink}
                onChange={(e) => setFavDrink(e.target.value)}
                placeholder="Ej. Latte Vainilla"
                className="w-full rounded-lg border-gray-300 shadow-sm focus:border-amber-500 focus:ring-amber-500 px-3 py-2 text-gray-900 border"
              />
            </div>

            <button
              onClick={handleSavePreferences}
              className="w-full py-3 bg-black text-white rounded-xl font-bold hover:bg-gray-800 transition-colors"
            >
              Guardar y Continuar
            </button>
          </div>
        </div>
      )}

      <div className="pb-6">
        <PoweredBy />
      </div>

    </main>
  );
}
</file>

<file path="src/app/promo/[id]/page.tsx">
'use client';

import { Suspense, useEffect, useState } from 'react';
import { notFound, useSearchParams } from 'next/navigation';
import { QRCodeSVG } from 'qrcode.react';
import { supabase } from '@/lib/supabase';
import { useClientConfig } from '@/context/ClientConfigContext';
import { Loader2, AlertCircle, CheckCircle2 } from 'lucide-react';

function PromoContent({ params }: { params: { id: string } }) {
    const [status, setStatus] = useState<'loading' | 'active' | 'inactive' | 'error'>('loading');
    const [campaign, setCampaign] = useState<any>(null);
    const searchParams = useSearchParams();
    const userEmail = searchParams.get('user');
    const config = useClientConfig();

    useEffect(() => {
        const checkCampaign = async () => {
            if (!params.id || !userEmail) {
                setStatus('error');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('campaigns')
                    .select('*')
                    .eq('id', params.id)
                    .single();

                if (error || !data) {
                    setStatus('error');
                    return;
                }

                setCampaign(data);
                setStatus(data.status === 'active' ? 'active' : 'inactive');
            } catch (err) {
                setStatus('error');
            }
        };

        checkCampaign();
    }, [params.id, userEmail]);

    if (status === 'loading') {
        return <div className="min-h-screen flex items-center justify-center bg-gray-50"><Loader2 className="animate-spin text-blue-600" size={32} /></div>;
    }

    if (status === 'error') {
        return (
            <div className="min-h-screen flex items-center justify-center bg-gray-50 p-6">
                <div className="text-center space-y-4 max-w-md">
                    <div className="bg-red-100 p-4 rounded-full w-16 h-16 flex items-center justify-center mx-auto text-red-600">
                        <AlertCircle size={32} />
                    </div>
                    <h1 className="text-xl font-bold text-gray-800">Enlace no vÃ¡lido</h1>
                    <p className="text-gray-500">No pudimos encontrar la promociÃ³n solicitada.</p>
                </div>
            </div>
        );
    }

    if (status === 'inactive') {
        return (
            <div className="min-h-screen flex items-center justify-center bg-gray-50 p-6">
                <div className="text-center space-y-4 max-w-md">
                    <div className="bg-gray-200 p-4 rounded-full w-16 h-16 flex items-center justify-center mx-auto text-gray-500">
                        <AlertCircle size={32} />
                    </div>
                    <h1 className="text-xl font-bold text-gray-800">PromociÃ³n Finalizada</h1>
                    <p className="text-gray-500">Lo sentimos, esta campaÃ±a {campaign?.title} ya no estÃ¡ disponible.</p>
                </div>
            </div>
        );
    }

    // QR Data Payload
    const qrPayload = JSON.stringify({
        type: 'promo',
        campaignId: campaign.id,
        user: userEmail,
        timestamp: Date.now() // Prevent replay attacks if we check this in scanner
    });

    return (
        <div className="min-h-screen bg-gray-50 flex flex-col items-center justify-center p-6 relative overflow-hidden">
            <div className="absolute top-0 w-full h-64 bg-blue-900 rounded-b-[40px] z-0" style={{ backgroundColor: config.theme.primaryColor }}></div>

            <div className="bg-white rounded-3xl shadow-xl p-8 w-full max-w-sm z-10 text-center space-y-6 animate-in slide-in-from-bottom-4 duration-500">
                <div className="space-y-4 flex flex-col items-center">
                    {config.assets?.logo ? (
                        <div className="w-48 h-48 mb-4 relative">
                            <img
                                src={config.assets.logo}
                                alt={config.name}
                                className="w-full h-full object-contain"
                            />
                        </div>
                    ) : (
                        <h2 className="text-xs font-bold text-blue-600 uppercase tracking-widest">{config.name}</h2>
                    )}
                    <h1 className="text-2xl font-black text-gray-800 leading-tight">{campaign.title}</h1>
                </div>

                <div className="bg-white p-4 rounded-2xl border-2 border-dashed border-gray-200 inline-block relative group">
                    <QRCodeSVG value={qrPayload} size={200} level="H" className="mx-auto" />
                    <div className="absolute -bottom-3 left-1/2 -translate-x-1/2 bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold shadow-sm whitespace-nowrap flex items-center gap-1">
                        <CheckCircle2 size={12} /> Listo para Canjear
                    </div>
                </div>

                <p className="text-sm text-gray-500">
                    Muestra este cÃ³digo QR al staff para validar tu beneficio.
                </p>
            </div>

            <p className="mt-8 text-xs text-center text-gray-400 z-10">
                Usuario: {userEmail}
            </p>
        </div>
    );
}

export default function PromoPage({ params }: { params: { id: string } }) {
    return (
        <Suspense fallback={<div className="min-h-screen flex items-center justify-center bg-gray-50">Cargando...</div>}>
            <PromoContent params={params} />
        </Suspense>
    );
}
</file>

<file path="src/app/staff/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { useClientConfig } from '@/context/ClientConfigContext';
import { ClientConfig } from '@/config/types';
import PoweredBy from '@/components/PoweredBy';
import Scanner from '@/components/Scanner';
import { Scan, LogOut, Coffee, Clock, Gift } from 'lucide-react';
import { supabase } from '@/lib/supabase';

export default function StaffDashboard() {
    const router = useRouter();
    const config = useClientConfig();
    const [showScanner, setShowScanner] = useState(false);
    const [loading, setLoading] = useState(true);
    const [scanCount, setScanCount] = useState(0);
    const [recentLogs, setRecentLogs] = useState<any[]>([]);

    const [isAdmin, setIsAdmin] = useState(false);

    useEffect(() => {
        const init = async () => {
            // Config from context
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) { router.push('/auth/login?role=staff'); return; }

            const { data: profile } = await supabase.from('profiles').select('role, client_code').eq('id', user.id).single();
            if (!profile || (profile.role !== 'staff' && profile.role !== 'admin')) {
                alert('Acceso denegado: No eres Staff.');
                router.push('/');
                return;
            }

            // Client Isolation Check
            let isValidUser = true;
            if (profile.role !== 'admin') {
                if (config.code === 'perezoso_cafe') {
                    if (profile.client_code !== 'perezoso_cafe') isValidUser = false;
                } else if (config.code === 'mare_cafe') {
                    if (profile.client_code && profile.client_code !== 'mare_cafe') isValidUser = false;
                } else {
                    if (profile.client_code && profile.client_code !== config.code) isValidUser = false;
                }
            }

            if (!isValidUser) {
                alert(`Esta cuenta de staff no pertenece a ${config.name}.`);
                await supabase.auth.signOut();
                router.push('/');
                return;
            }

            if (profile.role === 'admin') {
                setIsAdmin(true);
            }

            await fetchLogs(config, profile.client_code);
            setLoading(false);

            // Realtime Subscription
            const changes = supabase
                .channel('staff-dashboard-realtime')
                .on(
                    'postgres_changes',
                    { event: 'INSERT', schema: 'public', table: 'transaction_logs' },
                    (payload) => {
                        console.log('New log:', payload);
                        fetchLogs(config, profile.client_code);
                    }
                )
                .subscribe();

            return () => {
                supabase.removeChannel(changes);
            };
        };
        init();
    }, [router, config]);

    const fetchLogs = async (cfg: ClientConfig, userClientCode: string) => {
        const today = new Date().toISOString().split('T')[0];
        let query = supabase.from('transaction_logs')
            .select('id, created_at, description, type, profiles!transaction_logs_user_id_fkey!inner(client_code)')
            .order('created_at', { ascending: false })
            .limit(5);

        // Filter by Client Code
        if (cfg.code === 'mare_cafe') {
            query = query.or('client_code.eq.mare_cafe,client_code.is.null', { foreignTable: 'profiles' });
        } else {
            query = query.eq('profiles.client_code', cfg.code);
        }

        const { data } = await query;
        if (data) setRecentLogs(data);
    };

    const handleLogout = async () => {
        await supabase.auth.signOut();
        router.push('/');
    };

    const handleScanOperation = async (targetId: string, force = false): Promise<any> => {
        const { data, error } = await supabase.rpc('add_stamp', { target_user_id: targetId, force_override: force });
        if (error) return { success: false, message: error.message };
        return data;
    };

    const handleRedemption = async (targetId: string) => {
        const { data, error } = await supabase.rpc('redeem_reward', { target_user_id: targetId });
        if (error) return { success: false, message: error.message };
        return data;
    };

    const handleScan = async (scannedData: string) => {
        if (!config) return;

        // TRY TO PARSE JSON (PROMO QR)
        try {
            if (scannedData.startsWith('{')) {
                const data = JSON.parse(scannedData);
                if (data.type === 'promo') {
                    // --- PROMO REDEMPTION FLOW ---
                    const { campaignId, user } = data;

                    // 1. Verify Campaign Status
                    const { data: campaign, error } = await supabase.from('campaigns').select('status, title').eq('id', campaignId).single();

                    if (error || !campaign) {
                        alert('âŒ Error: CampaÃ±a no encontrada o invÃ¡lida.');
                        setShowScanner(false);
                        return;
                    }

                    if (campaign.status !== 'active') {
                        alert(`âŒ PROMOCIÃ“N VENCIDA O INACTIVA\n\nCampaÃ±a: ${campaign.title}\nEstado: ${campaign.status}`);
                        setShowScanner(false);
                        return;
                    }

                    // 2. Validate User (Optional: check if already redeemed?)
                    // For now, simpler flow: "Valid"
                    const confirmRedeem = confirm(`âœ… PROMOCIÃ“N VÃLIDA\n\nCampaÃ±a: ${campaign.title}\nUsuario: ${user}\n\nÂ¿Registrar canje?`);

                    if (confirmRedeem) {
                        // Log usage
                        await supabase.from('transaction_logs').insert({
                            user_id: user, // Note: user here is email, but we might need UUID. Profiles lookup needed?
                            // For simplicity, let's log description. 'user_id' in DB is uuid. 
                            // If we don't have UUID content in QR, we need to fetch it or store email in metadata?
                            // Ideally QR should contain user UUID.
                            // Let's assume user email is okay for description but we need UUID for foreign key if enforces.
                            // Wait, previous code used scannedData as user_id directly. This means user QR is UUID.
                            // Our new QR has { user: email }. 
                            // We need to fetch UUID from email.
                            type: 'promo_redeem',
                            description: `Canje PromociÃ³n: ${campaign.title}`
                        });

                        // We need the UUID to log correctly if we enforce FK. 
                        // Let's fetch it quickly. 
                        const { data: profile } = await supabase.from('profiles').select('id').eq('email', user).single();
                        if (profile) {
                            await supabase.from('transaction_logs').insert({
                                user_id: profile.id,
                                type: 'promo_redeem',
                                description: `Canje PromociÃ³n: ${campaign.title}`
                            });
                        }

                        alert('âœ… Canje registrado exitosamente.');
                        setScanCount(prev => prev + 1);
                    }
                    setShowScanner(false);
                    return;
                }
            }
        } catch (e) {
            // Not JSON, continue to normal flow
        }

        // --- NORMAL USER FLOW (STAMP) ---

        // 1. Check current stamps first
        const { data: stampData } = await supabase.from('stamps').select('count').eq('user_id', scannedData).single();
        const currentStamps = stampData?.count || 0;

        // 2. REWARD LOGIC: Dynamic from config
        const stampsNeeded = config.rules.stampsPerReward;
        if (currentStamps >= stampsNeeded) {
            const wantsToRedeem = confirm(`ðŸŽ‰ Â¡PREMIO DISPONIBLE! ðŸŽ‰\n\nEl cliente tiene ${currentStamps} sellos.\nÂ¿Desea canjear el CafÃ© Gratis ahora?`);

            if (wantsToRedeem) {
                const pin = prompt('ðŸ” AutorizaciÃ³n Requerida\nIngrese PIN de Admin para canjear:');
                const { data: verification } = await supabase.rpc('verify_shop_pin', { input_pin: pin, shop_code: config.code });

                if (verification?.valid && verification?.role === 'admin') {
                    const result = await handleRedemption(scannedData);
                    if (result.success) {
                        alert('âœ… ' + result.message);
                        setScanCount(prev => prev + 1); // Count as activity
                        setShowScanner(false);
                        return;
                    } else {
                        alert('âŒ Error: ' + result.message);
                        return;
                    }
                } else {
                    alert('PIN Incorrecto o insuficientes permisos. Canje cancelado.');
                    return;
                }
            }
            // If they chose NO, we proceed to try adding a stamp (normal flow)? 
            // Or maybe just cancel? Let's ask.
            const addStampInstead = confirm('Â¿Desea sumar un punto normal en su lugar?');
            if (!addStampInstead) {
                setShowScanner(false);
                return;
            }
        }

        // 3. Normal ADD STAMP Logic (Existing)
        const result = await handleScanOperation(scannedData, false);

        if (result.success) {
            alert('Â¡Sello agregado correctamente!');
            setScanCount(prev => prev + 1);
            setShowScanner(false);
        } else if (result.code === 'COOLDOWN_ACTIVE') {
            const pin = prompt(`âš ï¸ BLOQUEADO POR REGLA 24HS.\nEste cliente ya sumÃ³ hoy.\n\nPara autorizar excepciÃ³n, ingrese PIN de Admin:`);
            const { data: verification } = await supabase.rpc('verify_shop_pin', { input_pin: pin, shop_code: config.code });

            if (verification?.valid && verification?.role === 'admin') {
                const overrideResult = await handleScanOperation(scannedData, true);
                if (overrideResult.success) {
                    alert('âœ… ExcepciÃ³n Autorizada. Sello agregado.');
                    setScanCount(prev => prev + 1);
                    setShowScanner(false);
                } else {
                    alert('Error al forzar: ' + overrideResult.message);
                }
            } else {
                alert('PIN Incorrecto o insuficientes permisos.');
            }
        } else {
            alert('Error: ' + result.message);
        }
    };

    if (loading) return <div className="flex h-screen items-center justify-center">Cargando...</div>;

    return (
        <main className="min-h-screen bg-gray-50 font-sans">
            <nav className="bg-white shadow-sm px-6 py-4 flex justify-between items-center">
                <div className="flex items-center gap-3">
                    {config.assets?.logo ? (
                        <img
                            src={config.assets.logo}
                            alt={config.name}
                            className="h-24 w-auto object-contain"
                        />
                    ) : (
                        <div className="bg-black text-white p-2 rounded-lg"><Coffee size={20} /></div>
                    )}
                    <span className="font-bold text-gray-800 text-lg">Staff Portal</span>
                </div>
                <div className="flex items-center gap-4">
                    {isAdmin && (
                        <button
                            onClick={() => router.push('/admin')}
                            className="text-sm font-bold text-blue-600 bg-blue-50 px-3 py-1.5 rounded-lg hover:bg-blue-100 transition"
                        >
                            Volver a Admin
                        </button>
                    )}
                    <button onClick={handleLogout} className="text-sm font-medium text-gray-500 hover:text-red-600 transition">Cerrar SesiÃ³n</button>
                </div>
            </nav>

            <div className="max-w-4xl mx-auto p-6 space-y-8">
                <section className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 className="text-gray-400 text-sm font-medium uppercase">Tus Escaneos (Hoy)</h3>
                        <p className="text-4xl font-bold mt-2">{scanCount}</p>
                    </div>

                    <button onClick={() => setShowScanner(true)} className="group relative overflow-hidden bg-black text-white p-6 rounded-2xl shadow-lg flex items-center justify-between hover:shadow-xl transition-all" style={{ backgroundColor: config.theme.primaryColor }}>
                        <div><h3 className="text-white/90 font-medium text-lg">Escanear Cliente</h3><p className="text-white/60 text-sm">CÃ¡mara o ingreso manual</p></div>
                        <div className="bg-white/20 p-3 rounded-full group-hover:scale-110 transition-transform"><Scan size={32} /></div>
                    </button>
                </section>

                <section>
                    <h3 className="font-semibold text-gray-800 mb-4">Actividad Reciente</h3>
                    <div className="bg-white rounded-xl shadow-sm border border-gray-100 divide-y divide-gray-50">
                        {recentLogs.length === 0 ? (
                            <div className="p-8 text-center text-gray-400">
                                <Clock className="mx-auto mb-2 opacity-50" size={32} />
                                <p>No hay actividad reciente.</p>
                            </div>
                        ) : (
                            recentLogs.map((log) => (
                                <div key={log.id} className="p-4 flex items-center justify-between">
                                    <div>
                                        <p className="font-medium text-gray-800 text-sm">{log.description}</p>
                                        <p className="text-xs text-gray-400">{new Date(log.created_at).toLocaleTimeString()}</p>
                                    </div>
                                    <span className={`px-2 py-1 rounded-full text-xs font-bold ${log.type === 'add_stamp' ? 'bg-emerald-100 text-emerald-700' : 'bg-purple-100 text-purple-700'}`}>
                                        {log.type === 'add_stamp' ? 'Sello' : 'Canje'}
                                    </span>
                                </div>
                            ))
                        )}
                    </div>
                </section>
            </div>

            {showScanner && <Scanner onScan={handleScan} onClose={() => setShowScanner(false)} />}

            <div className="pb-6">
                <PoweredBy />
            </div>
        </main>
    );
}
</file>

<file path="src/app/error.tsx">
'use client';

import { useEffect } from 'react';
import { RefreshCcw, AlertTriangle } from 'lucide-react';
import PoweredBy from '@/components/PoweredBy';

export default function GlobalError({
    error,
    reset,
}: {
    error: Error & { digest?: string };
    reset: () => void;
}) {
    useEffect(() => {
        console.error(error);
    }, [error]);

    return (
        <div className="bg-gray-50 flex items-center justify-center min-h-screen p-6 font-sans">
            <div className="bg-white rounded-3xl shadow-xl p-8 max-w-md w-full text-center border border-red-100">
                <div className="bg-red-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6">
                    <AlertTriangle size={32} className="text-red-500" />
                </div>

                <h2 className="text-2xl font-bold text-gray-800 mb-2">Â¡Ups! Algo saliÃ³ mal.</h2>
                <p className="text-gray-500 text-sm mb-8">
                    Ha ocurrido un error inesperado en la aplicaciÃ³n. Nuestro equipo ha sido notificado.
                </p>

                <div className="bg-gray-50 p-4 rounded-xl text-left mb-8 border border-gray-100 overflow-hidden">
                    <p className="text-xs font-mono text-gray-400">Error Digest: {error.digest}</p>
                    <p className="text-xs font-mono text-gray-600 mt-1 truncate">{error.message}</p>
                </div>

                <div className="flex gap-4">
                    <button
                        onClick={() => window.location.href = '/'}
                        className="flex-1 bg-white border border-slate-200 text-slate-600 font-bold py-3 rounded-xl hover:bg-slate-50 transition"
                    >
                        Ir al Inicio
                    </button>
                    <button
                        onClick={() => reset()}
                        className="flex-1 bg-slate-900 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 hover:bg-slate-800 transition shadow-lg shadow-blue-900/10"
                    >
                        <RefreshCcw size={18} /> Reintentar
                    </button>
                </div>

                <div className="mt-8">
                    <PoweredBy />
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/app/globals.css">
@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}
</file>

<file path="src/app/layout.tsx">
import type { Metadata, Viewport } from "next";
import { Geist, Geist_Mono, Playfair_Display } from "next/font/google";
import IOSInstallPrompt from "@/components/IOSInstallPrompt";
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

const playfair = Playfair_Display({
  variable: "--font-playfair",
  subsets: ["latin"],
});

import { Fredoka } from "next/font/google";

const fredoka = Fredoka({
  variable: "--font-fredoka",
  subsets: ["latin"],
  weight: ["400", "500", "600", "700"],
});

import { getShopConfig } from "@/lib/shop-service";
import { ClientConfigProvider } from "@/context/ClientConfigContext";

const CLIENT_CODE = process.env.NEXT_PUBLIC_CLIENT_CODE || 'mare_cafe';

export async function generateMetadata(): Promise<Metadata> {
  const config = await getShopConfig(CLIENT_CODE);

  if (!config) return { title: 'Loyalty App' };

  const icon = config.assets.favicon || config.assets.logo;

  return {
    title: `${config.name} Loyalty`,
    description: config.texts.welcomeSubtitle || "Tu tarjeta de fidelidad digital",
    manifest: "/manifest.webmanifest",
    icons: {
      icon: icon,
      apple: icon,
    },
  };
}

export const viewport: Viewport = {
  themeColor: "#000000",
  width: "device-width",
  initialScale: 1,
  maximumScale: 1,
};

export default async function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  const config = await getShopConfig(CLIENT_CODE);

  // If config fails to load, we should probably show a critical error or fallback
  // For now, we'll let it pass as null to context (which throws) or handle it gracefully?
  // The service returns a default config on error, so it should be fine.

  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable} ${playfair.variable} ${fredoka.variable} antialiased`}
      >
        {config ? (
          <ClientConfigProvider config={config}>
            {children}
          </ClientConfigProvider>
        ) : (
          <div className="flex items-center justify-center h-screen bg-slate-50 text-slate-800 font-bold">
            Error loading shop configuration.
          </div>
        )}
        <IOSInstallPrompt />
      </body>
    </html>
  );
}
</file>

<file path="src/app/manifest.ts">
import { MetadataRoute } from 'next';
import { getShopConfig } from '@/lib/shop-service';

export default async function manifest(): Promise<MetadataRoute.Manifest> {
    const config = await getShopConfig(process.env.NEXT_PUBLIC_CLIENT_CODE || 'mare_cafe');

    if (!config) {
        return {
            name: 'Loyalty App',
            short_name: 'Loyalty',
            start_url: '/',
            display: 'standalone',
            icons: []
        }
    }

    const iconPath = config.assets.favicon || config.assets.logo;

    return {
        name: config.name,
        short_name: config.name,
        description: config.texts.welcomeSubtitle,
        start_url: '/',
        display: 'standalone',
        background_color: config.theme.secondaryColor, // Improved contrast usually
        theme_color: config.theme.primaryColor,
        icons: [
            {
                src: iconPath,
                sizes: '192x192',
                type: 'image/png',
            },
            {
                src: iconPath,
                sizes: '512x512',
                type: 'image/png',
            },
        ],
    };
}
</file>

<file path="src/app/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import Image from 'next/image';
import { useClientConfig } from '@/context/ClientConfigContext';
import { User, Store, Loader2 } from 'lucide-react';
import { supabase } from '@/lib/supabase';

export default function LandingPage() {
  const router = useRouter();
  const config = useClientConfig();
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const checkSession = async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        // Fetch profile to know role
        const { data: profile } = await supabase
          .from('profiles')
          .select('role')
          .eq('id', session.user.id)
          .single();

        if (profile) {
          if (profile.role === 'customer') router.push('/client');
          else if (profile.role === 'admin') router.push('/admin');
          else router.push('/staff');
          return;
        }
      }
      setLoading(false);
    };
    checkSession();
  }, [router]);

  if (loading) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center space-y-4" style={{ backgroundColor: config.theme.primaryColor }}>
        {/* INCREASED LOADING SIZE: w-44 h-44 */}
        <div className="w-44 h-44 bg-white/5 rounded-full flex items-center justify-center backdrop-blur-sm animate-pulse">
          {config.assets?.logo && (
            <Image src={config.assets.logo} alt="Loading" width={120} height={120} className="object-contain opacity-80" />
          )}
        </div>
      </div>
    );
  }

  return (
    <main className="fixed inset-0 flex flex-col items-center justify-between p-6 text-center"
      style={{ backgroundColor: config.theme.primaryColor, color: 'white' }}>

      {/* Main Content Centered */}
      <div className="flex-1 flex flex-col items-center justify-center w-full max-w-md space-y-10">

        <div className="space-y-6 animate-in fade-in zoom-in duration-700 mt-12">
          {/* REDUCED SIZE: w-72 h-72 (10% smaller than w-80) */}
          <div className="w-72 h-72 flex items-center justify-center mx-auto relative">
            <div className="relative w-full h-full">
              {config.assets?.logo && (
                <Image
                  src={config.assets.logo}
                  alt={config.name}
                  fill
                  className="object-contain scale-150"
                  priority
                />
              )}
            </div>
          </div>

          <div className="space-y-2">
            <h1 className="text-4xl font-bold tracking-tight">{config.name}</h1>
            <p className="text-lg text-white/70 max-w-xs mx-auto leading-relaxed font-light">
              {config.texts.welcomeSubtitle}
            </p>
          </div>
        </div>

        {/* Actions - Modernized & Cleaner */}
        <div className="w-full space-y-4 animate-in slide-in-from-bottom-4 duration-1000 delay-300">
          <Link
            href="/auth/login?role=customer"
            className="group relative w-full flex items-center justify-center gap-3 p-5 bg-white text-black rounded-full shadow-xl hover:shadow-2xl hover:scale-[1.02] active:scale-95 transition-all font-bold text-xl overflow-hidden"
          >
            <User className="w-6 h-6 text-gray-900" />
            <span>Soy Cliente</span>
          </Link>

          <Link
            href="/auth/login?role=staff"
            className="w-full flex items-center justify-center gap-3 p-4 text-white/60 hover:text-white hover:bg-white/10 rounded-full transition-all font-medium text-sm backdrop-blur-md"
          >
            <Store className="w-4 h-4" />
            <span>Acceso Staff</span>
          </Link>
        </div>
      </div>

      {/* Footer - Pinned Bottom */}
      <footer className="w-full pt-6 pb-2 text-[10px] text-white/30 font-medium tracking-[0.2em] uppercase">
        Desarrollado por <span className="font-bold text-white/50">BRANDIA</span>
      </footer>
    </main>
  );
}
</file>

<file path="src/components/admin/ClientsTab.tsx">
'use client';

import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';
import { useClientConfig } from '@/context/ClientConfigContext';
import { Search, QrCode, Smartphone, Mail, Calendar, User, Download } from 'lucide-react';
import QRCode from 'react-qr-code';

interface ClientProfile {
    id: string;
    email: string;
    full_name?: string;
    phone?: string;
    level?: number;
    created_at: string;
    stamps?: number;
}

export default function ClientsTab() {
    const config = useClientConfig();
    const [clients, setClients] = useState<ClientProfile[]>([]);
    const [loading, setLoading] = useState(true);
    const [searchTerm, setSearchTerm] = useState('');
    const [showQR, setShowQR] = useState(false);

    useEffect(() => {
        const fetchClients = async () => {

            let query = supabase
                .from('profiles')
                .select('*, stamps(count)') // select stamps too
                .eq('role', 'customer');

            if (config.code === 'mare_cafe') {
                query = query.or('client_code.eq.mare_cafe,client_code.is.null');
            } else {
                query = query.eq('client_code', config.code);
            }

            const { data } = await query
                .order('created_at', { ascending: false });

            if (data) {
                // Map stamps count cleanly
                const formatted = data.map(c => ({
                    ...c,
                    stamps: c.stamps?.[0]?.count || 0 // Assuming one-to-one or taking first
                }));
                setClients(formatted);
            }
            setLoading(false);
        };
        fetchClients();
    }, [config]);

    const filteredClients = clients.filter(c =>
    (c.email?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        c.full_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        c.phone?.includes(searchTerm))
    );

    const downloadQR = () => {
        const svg = document.getElementById("registration-qr");
        if (svg) {
            const svgData = new XMLSerializer().serializeToString(svg);
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx?.drawImage(img, 0, 0);
                const pngFile = canvas.toDataURL("image/png");
                const downloadLink = document.createElement("a");
                downloadLink.download = "mare-registro-qr.png";
                downloadLink.href = pngFile;
                downloadLink.click();
            };
            img.src = "data:image/svg+xml;base64," + btoa(svgData);
        }
    };

    const registroUrl = typeof window !== 'undefined' ? `${window.location.origin}/auth/login?role=customer` : '';

    return (
        <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500">

            {/* Header & QR Action */}
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div className="bg-white p-6 rounded-3xl shadow-md border border-slate-100 flex-1 w-full">
                    <div className="flex justify-between items-center">
                        <div>
                            <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                <User size={24} className="text-blue-600" /> Base de Datos de Clientes
                            </h3>
                            <p className="text-slate-400 text-sm mt-1">
                                {clients.length} clientes registrados en total.
                            </p>
                        </div>
                        <button
                            onClick={() => setShowQR(!showQR)}
                            className="flex items-center gap-2 bg-slate-900 text-white px-4 py-2 rounded-xl font-bold hover:bg-slate-700 transition"
                        >
                            <QrCode size={18} /> {showQR ? 'Ocultar QR' : 'Ver QR de Registro'}
                        </button>
                    </div>

                    {showQR && (
                        <div className="mt-6 p-6 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-300 flex flex-col items-center text-center animate-in fade-in">
                            <h4 className="font-bold text-slate-800 mb-2">QR para Nuevos Clientes</h4>
                            <p className="text-sm text-slate-500 mb-4 max-w-sm">
                                Muestra este cÃ³digo a los clientes para que se registren rÃ¡pidamente en la app desde sus celulares.
                            </p>
                            <div className="p-4 bg-white rounded-xl shadow-sm mb-4">
                                <QRCode
                                    id="registration-qr"
                                    value={registroUrl}
                                    size={200}
                                    fgColor="#1E3A8A"
                                />
                            </div>
                            {/* <button onClick={downloadQR} className="text-blue-600 text-sm font-bold flex items-center gap-1 hover:underline">
                        <Download size={14} /> Descargar PNG
                    </button> */}
                            <p className="text-xs text-slate-400 mt-2">{registroUrl}</p>
                        </div>
                    )}
                </div>
            </div>

            {/* Search & List */}
            <div className="bg-white p-6 rounded-3xl shadow-md border border-slate-100">
                <div className="relative mb-6">
                    <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={20} />
                    <input
                        type="text"
                        placeholder="Buscar por nombre, email o telÃ©fono..."
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="w-full pl-12 pr-4 py-3 bg-slate-50 border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition"
                    />
                </div>

                <div className="overflow-x-auto">
                    <table className="w-full text-left border-collapse">
                        <thead>
                            <tr className="border-b border-slate-100 text-slate-400 text-xs uppercase tracking-wider">
                                <th className="p-4 font-semibold">Cliente</th>
                                <th className="p-4 font-semibold">Contacto</th>
                                <th className="p-4 font-semibold text-center">Nivel</th>
                                <th className="p-4 font-semibold text-center">Registrado</th>
                            </tr>
                        </thead>
                        <tbody className="text-slate-600 text-sm">
                            {loading ? (
                                <tr><td colSpan={4} className="p-8 text-center">Cargando datos...</td></tr>
                            ) : (
                                filteredClients.map((client) => (
                                    <tr key={client.id} className="border-b border-slate-50 hover:bg-slate-50 transition">
                                        <td className="p-4">
                                            <div className="font-bold text-slate-800">{client.full_name || 'Sin Nombre'}</div>
                                            <div className="text-xs text-slate-400">ID: {client.id.slice(0, 8)}...</div>
                                        </td>
                                        <td className="p-4 space-y-1">
                                            <div className="flex items-center gap-2 text-xs">
                                                <Mail size={14} className="text-blue-400" /> {client.email}
                                            </div>
                                            {client.phone && (
                                                <div className="flex items-center gap-2 text-xs text-slate-500">
                                                    <Smartphone size={14} className="text-green-500" /> {client.phone}
                                                </div>
                                            )}
                                        </td>
                                        <td className="p-4 text-center">
                                            <span className="bg-amber-100 text-amber-700 px-3 py-1 rounded-full text-xs font-bold">
                                                Lvl {client.level || 1}
                                            </span>
                                        </td>
                                        <td className="p-4 text-center text-xs text-slate-400">
                                            {new Date(client.created_at).toLocaleDateString()}
                                        </td>
                                    </tr>
                                ))
                            )}
                            {!loading && filteredClients.length === 0 && (
                                <tr><td colSpan={4} className="p-8 text-center text-slate-400">No se encontraron clientes.</td></tr>
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/components/admin/EmailEditor.tsx">
'use client';

import { useState, useEffect } from 'react';
import { X, Layout, Type, Image as ImageIcon, Send, Smartphone, Monitor, Palette } from 'lucide-react';

interface EmailEditorProps {
    initialData: {
        title: string;
        content: string;
        imageUrl?: string;
        offer?: string;
    };
    onClose: () => void;
    onSend: (data: { title: string; content: string; html: string; audience: string }) => Promise<void>;
    audience: string;
    isSending: boolean;
}

export default function EmailEditor({ initialData, onClose, onSend, audience, isSending }: EmailEditorProps) {
    const [viewMode, setViewMode] = useState<'mobile' | 'desktop'>('mobile');
    const [formData, setFormData] = useState({
        title: initialData.title || 'Â¡Tenemos novedades!',
        content: initialData.content || 'Hola, tenemos algo especial para ti...',
        offer: initialData.offer || '',
        imageUrl: initialData.imageUrl || '',
        primaryColor: '#1E3A8A',
        buttonText: 'Canjear Ahora',
        buttonUrl: '{{PROMO_LINK}}'
    });

    const generateEmailHtml = (data: typeof formData) => {
        return `
<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin:0; padding:0; background-color:#F3F4F6; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;">
    <div style="max-width: 600px; margin: 0 auto; background-color: #ffffff; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
        <!-- Header Image -->
        ${data.imageUrl ? `
        <div style="width: 100%; height: 300px; background-image: url('${data.imageUrl}'); background-size: cover; background-position: center; position: relative;">
            <div style="position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0.6));"></div>
        </div>
        ` : ''}
        
        <!-- Content -->
        <div style="padding: 40px 30px; text-align: center;">
            <h1 style="color: ${data.primaryColor}; font-size: 28px; font-weight: 800; margin-bottom: 16px; margin-top: 0;">${data.title}</h1>
            
            ${data.offer ? `
            <div style="background-color: #EFF6FF; border: 2px dashed ${data.primaryColor}; padding: 15px; border-radius: 12px; margin: 20px 0; display: inline-block;">
                <span style="font-size: 24px; font-weight: bold; color: ${data.primaryColor};">${data.offer}</span>
            </div>
            ` : ''}

            <p style="color: #4B5563; font-size: 16px; line-height: 1.6; margin-bottom: 30px;">
                ${data.content.replace(/\n/g, '<br/>')}
            </p>

            <a href="${data.buttonUrl}" style="background-color: ${data.primaryColor}; color: #ffffff; padding: 16px 32px; border-radius: 50px; text-decoration: none; font-weight: bold; font-size: 16px; display: inline-block; box-shadow: 0 4px 14px 0 rgba(0,0,0,0.39);">
                ${data.buttonText}
            </a>
        </div>

        <!-- Footer -->
        <div style="background-color: #F9FAFB; padding: 30px; text-align: center; border-top: 1px solid #E5E7EB;">
            <p style="color: #9CA3AF; font-size: 12px;">
                Mare Cafe - Programa de Fidelidad<br/>
                Sigue disfrutando de tu cafÃ© favorito.
            </p>
            <div style="margin-top: 10px;">
                <a href="#" style="color: #9CA3AF; font-size: 12px; text-decoration: underline;">Darse de baja</a>
            </div>
        </div>
    </div>
</body>
</html>
        `;
    };

    const htmlPreview = generateEmailHtml(formData);

    const handleSubmit = async () => {
        await onSend({
            title: formData.title,
            content: formData.content,
            html: htmlPreview,
            audience
        });
    };

    return (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in fade-in duration-200">
            <div className="bg-white rounded-3xl w-full max-w-6xl h-[90vh] flex overflow-hidden shadow-2xl">

                {/* Visual Editor Sidebar */}
                <div className="w-1/3 border-r border-slate-100 bg-slate-50 flex flex-col">
                    <div className="p-6 border-b border-slate-200 bg-white">
                        <div className="flex justify-between items-center">
                            <h2 className="font-bold text-xl text-slate-800 flex items-center gap-2">
                                <Palette size={20} className="text-blue-600" /> Editor
                            </h2>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-full text-slate-400 hover:text-red-500 transition">
                                <X size={20} />
                            </button>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-6 space-y-6">
                        {/* Image Section */}
                        <div className="space-y-3">
                            <label className="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                                <ImageIcon size={14} /> Imagen de Cabecera
                            </label>
                            <div className="relative aspect-video rounded-xl overflow-hidden border-2 border-slate-200 group bg-slate-100">
                                {formData.imageUrl ? (
                                    <img src={formData.imageUrl} className="w-full h-full object-cover" />
                                ) : (
                                    <div className="flex items-center justify-center h-full text-slate-400 text-xs text-center p-4">
                                        Sin imagen seleccionada
                                    </div>
                                )}
                                <div className="absolute inset-0 bg-black/50 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition-all gap-2">
                                    <label className="cursor-pointer bg-white text-xs font-bold px-4 py-2 rounded-full hover:bg-blue-50 transition">
                                        Cambiar
                                        <input
                                            type="file"
                                            className="hidden"
                                            accept="image/*"
                                            onChange={(e) => {
                                                const file = e.target.files?.[0];
                                                if (file) {
                                                    const reader = new FileReader();
                                                    reader.onload = (e) => setFormData(p => ({ ...p, imageUrl: e.target?.result as string }));
                                                    reader.readAsDataURL(file);
                                                }
                                            }}
                                        />
                                    </label>
                                    <button
                                        onClick={() => setFormData(p => ({ ...p, imageUrl: '' }))}
                                        className="text-white text-xs hover:text-red-300"
                                    >
                                        Quitar
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Text Content */}
                        <div className="space-y-4">
                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">TÃ­tulo Principal</label>
                                <input
                                    type="text"
                                    value={formData.title}
                                    onChange={e => setFormData(p => ({ ...p, title: e.target.value }))}
                                    className="w-full p-3 rounded-xl border border-slate-200 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                    placeholder="Ej: Â¡Oferta Especial!"
                                />
                            </div>

                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">Oferta Destacada (Opcional)</label>
                                <input
                                    type="text"
                                    value={formData.offer}
                                    onChange={e => setFormData(p => ({ ...p, offer: e.target.value }))}
                                    className="w-full p-3 rounded-xl border border-slate-200 text-sm focus:ring-2 focus:ring-blue-500 outline-none font-bold text-blue-600 bg-blue-50"
                                    placeholder="Ej: 2x1 en Lattes"
                                />
                            </div>

                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">Contenido del Mensaje</label>
                                <textarea
                                    rows={5}
                                    value={formData.content}
                                    onChange={e => setFormData(p => ({ ...p, content: e.target.value }))}
                                    className="w-full p-3 rounded-xl border border-slate-200 text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none"
                                    placeholder="Escribe tu mensaje aquÃ­..."
                                ></textarea>
                            </div>
                        </div>

                        {/* Branding */}
                        <div className="space-y-4 pt-4 border-t border-slate-200">
                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">Color Primario</label>
                                <div className="flex gap-2">
                                    {['#1E3A8A', '#DC2626', '#059669', '#7C3AED', '#DB2777'].map(color => (
                                        <button
                                            key={color}
                                            onClick={() => setFormData(p => ({ ...p, primaryColor: color }))}
                                            className={`w-8 h-8 rounded-full border-2 transition-transform ${formData.primaryColor === color ? 'border-slate-800 scale-110' : 'border-transparent'}`}
                                            style={{ backgroundColor: color }}
                                        />
                                    ))}
                                    <input
                                        type="color"
                                        value={formData.primaryColor}
                                        onChange={e => setFormData(p => ({ ...p, primaryColor: e.target.value }))}
                                        className="w-8 h-8 rounded-full overflow-hidden border-0 p-0 cursor-pointer"
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">Texto del BotÃ³n</label>
                                <input
                                    type="text"
                                    value={formData.buttonText}
                                    onChange={e => setFormData(p => ({ ...p, buttonText: e.target.value }))}
                                    className="w-full p-3 rounded-xl border border-slate-200 text-sm"
                                />
                            </div>
                        </div>
                    </div>

                    <div className="p-6 border-t border-slate-200 bg-white">
                        <button
                            onClick={handleSubmit}
                            disabled={isSending}
                            className="w-full py-4 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition disabled:opacity-50 flex items-center justify-center gap-2"
                        >
                            <Send size={20} />
                            {isSending ? 'Enviando...' : `Enviar a ${audience}`}
                        </button>
                    </div>
                </div>

                {/* Live Preview Area */}
                <div className="flex-1 bg-slate-200 flex flex-col relative">
                    <div className="absolute top-6 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur-md px-2 py-1.5 rounded-full shadow-sm flex gap-1 z-10 border border-slate-200">
                        <button
                            onClick={() => setViewMode('mobile')}
                            className={`p-2 rounded-full transition ${viewMode === 'mobile' ? 'bg-slate-200 text-slate-900' : 'text-slate-400 hover:bg-slate-100'}`}
                        >
                            <Smartphone size={20} />
                        </button>
                        <button
                            onClick={() => setViewMode('desktop')}
                            className={`p-2 rounded-full transition ${viewMode === 'desktop' ? 'bg-slate-200 text-slate-900' : 'text-slate-400 hover:bg-slate-100'}`}
                        >
                            <Monitor size={20} />
                        </button>
                    </div>

                    <div className="flex-1 flex items-center justify-center p-8 overflow-y-auto">
                        <div
                            className={`bg-white shadow-2xl transition-all duration-500 overflow-hidden ${viewMode === 'mobile'
                                ? 'w-[375px] h-[750px] rounded-[40px] border-[8px] border-slate-900'
                                : 'w-[800px] h-[600px] rounded-xl border border-slate-300'
                                }`}
                        >
                            <iframe
                                srcDoc={htmlPreview}
                                className="w-full h-full border-0 bg-white"
                                title="Email Preview"
                            />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/components/client/menu/CategoryTabs.tsx">
import { Category } from '@/types/menu';

interface CategoryTabsProps {
    categories: Category[];
    selectedCategory: string;
    onSelect: (id: string) => void;
}

export default function CategoryTabs({ categories, selectedCategory, onSelect }: CategoryTabsProps) {
    return (
        <div className="sticky top-16 bg-white z-10 shadow-sm border-t border-gray-100">
            <div className="max-w-2xl mx-auto overflow-x-auto no-scrollbar py-3 px-4 flex gap-2">
                <button
                    onClick={() => onSelect('all')}
                    className={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-all ${selectedCategory === 'all'
                            ? 'bg-black text-white shadow-md'
                            : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                        }`}
                >
                    Todos
                </button>
                {categories.map((cat) => (
                    <button
                        key={cat.id}
                        onClick={() => onSelect(cat.id)}
                        className={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-all ${selectedCategory === cat.id
                                ? 'bg-black text-white shadow-md'
                                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                            }`}
                    >
                        {cat.name}
                    </button>
                ))}
            </div>
        </div>
    );
}
</file>

<file path="src/components/client/menu/MenuHeader.tsx">
import Link from 'next/link';
import { ArrowLeft, Coffee } from 'lucide-react';

interface MenuHeaderProps {
    title: string;
}

export default function MenuHeader({ title }: MenuHeaderProps) {
    return (
        <header className="fixed top-0 left-0 right-0 bg-white z-20 shadow-sm">
            <div className="max-w-2xl mx-auto px-4 h-16 flex items-center justify-between">
                <div className="flex items-center gap-3">
                    <Link href="/client" className="p-2 -ml-2 hover:bg-gray-100 rounded-full transition-colors">
                        <ArrowLeft className="w-6 h-6 text-gray-700" />
                    </Link>
                    <h1 className="text-lg font-bold text-gray-900 flex items-center gap-2">
                        <Coffee className="w-5 h-5 text-amber-600" />
                        {title}
                    </h1>
                </div>
            </div>
        </header>
    );
}
</file>

<file path="src/components/client/menu/ProductDetailModal.tsx">
import { Product } from '@/types/menu';
import { X, MapPin, Droplets, AlertTriangle, Ruler } from 'lucide-react';

interface ProductDetailModalProps {
    product: Product | null;
    onClose: () => void;
}

export default function ProductDetailModal({ product, onClose }: ProductDetailModalProps) {
    if (!product) return null;

    return (
        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
            {/* Backdrop */}
            <div
                className="absolute inset-0 bg-black/60 backdrop-blur-sm pointer-events-auto"
                onClick={onClose}
            />

            {/* Modal */}
            <div className="bg-white w-full max-w-md h-[85vh] sm:h-auto sm:max-h-[90vh] sm:rounded-3xl rounded-t-3xl shadow-2xl overflow-y-auto pointer-events-auto relative animate-in slide-in-from-bottom duration-300">

                {/* Close Button */}
                <button
                    onClick={onClose}
                    className="absolute top-4 right-4 z-10 bg-white/50 backdrop-blur-md p-2 rounded-full text-black hover:bg-white transition-colors"
                >
                    <X size={24} />
                </button>

                {/* Image Header */}
                <div className="h-64 sm:h-72 bg-gray-100 w-full relative">
                    {product.image && (
                        <img
                            src={product.image}
                            alt={product.name}
                            className="w-full h-full object-cover"
                        />
                    )}
                    <div className="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
                    <div className="absolute bottom-4 left-4 text-white">
                        <span className="bg-amber-500 text-white text-[10px] uppercase font-bold px-2 py-1 rounded mb-2 inline-block">
                            {product.category}
                        </span>
                        <h2 className="text-2xl font-bold">{product.name}</h2>
                    </div>
                </div>

                {/* Content */}
                <div className="p-6 space-y-6">

                    {/* Price & Description */}
                    <div>
                        <p className="text-3xl font-bold text-gray-900 mb-2">
                            ${product.price.toLocaleString('es-CL')}
                        </p>
                        <p className="text-gray-600 leading-relaxed">
                            {product.description}
                        </p>
                    </div>

                    <hr className="border-gray-100" />

                    {/* Attributes Grid */}
                    <div className="grid grid-cols-1 gap-4">

                        {product.attributes?.origin && (
                            <div className="bg-amber-50 p-4 rounded-xl flex items-start gap-3">
                                <MapPin className="text-amber-600 shrink-0" size={20} />
                                <div>
                                    <h4 className="font-bold text-amber-900 text-sm">Origen</h4>
                                    <p className="text-amber-800 text-sm">{product.attributes.origin}</p>
                                </div>
                            </div>
                        )}

                        {product.attributes?.tastingNotes && product.attributes.tastingNotes.length > 0 && (
                            <div className="bg-stone-50 p-4 rounded-xl flex items-start gap-3">
                                <Droplets className="text-stone-600 shrink-0" size={20} />
                                <div>
                                    <h4 className="font-bold text-stone-900 text-sm">Notas de Cata</h4>
                                    <div className="flex flex-wrap gap-2 mt-1">
                                        {product.attributes.tastingNotes.map(note => (
                                            <span key={note} className="bg-stone-200 text-stone-700 text-xs px-2 py-1 rounded-md font-medium">
                                                {note}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {product.attributes?.sizes && (
                            <div className="flex items-center gap-3 p-2 text-gray-500 text-sm">
                                <Ruler size={16} />
                                <span>Disponible en: {product.attributes.sizes.join(', ')}</span>
                            </div>
                        )}

                        {product.attributes?.allergens && (
                            <div className="flex items-center gap-3 p-2 text-red-500 text-sm bg-red-50 rounded-lg">
                                <AlertTriangle size={16} />
                                <span>Contiene: {product.attributes.allergens.join(', ')}</span>
                            </div>
                        )}

                    </div>

                    <div className="h-12"></div> {/* Spacer */}
                </div>

                {/* Sticky Footer Button (Just Close) */}
                <div className="absolute bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-100">
                    <button
                        onClick={onClose}
                        className="w-full py-4 bg-black text-white font-bold rounded-2xl hover:bg-gray-800 transition-colors"
                    >
                        Cerrar
                    </button>
                </div>

            </div>
        </div>
    );
}
</file>

<file path="src/components/client/menu/ProductGrid.tsx">
import { Product } from '@/types/menu';

interface ProductGridProps {
    products: Product[];
    onProductClick: (product: Product) => void;
}

export default function ProductGrid({ products, onProductClick }: ProductGridProps) {
    if (products.length === 0) {
        return (
            <div className="text-center py-12 text-gray-400">
                <p>No hay productos en esta categorÃ­a.</p>
            </div>
        );
    }

    return (
        <div className="grid grid-cols-2 gap-4 p-4 pb-24">
            {products.map((product) => (
                <div
                    key={product.id}
                    onClick={() => onProductClick(product)}
                    className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-shadow cursor-pointer active:scale-95 duration-200"
                >
                    <div className="aspect-square bg-gray-100 relative">
                        {/* Placeholder if image loading fails or is missing, though we assume good data */}
                        {product.image ? (
                            <img
                                src={product.image}
                                alt={product.name}
                                className="w-full h-full object-cover"
                                loading="lazy"
                            />
                        ) : (
                            <div className="w-full h-full flex items-center justify-center bg-gray-200 text-gray-400">
                                No Image
                            </div>
                        )}
                    </div>
                    <div className="p-3">
                        <h3 className="font-bold text-gray-800 text-sm line-clamp-1">{product.name}</h3>
                        <p className="text-gray-500 text-xs mt-1 font-medium">
                            ${product.price.toLocaleString('es-CL')}
                        </p>
                    </div>
                </div>
            ))}
        </div>
    );
}
</file>

<file path="src/components/client/AboutUs.tsx">
'use client';

import { ClientConfig } from '@/config/types';
import { useState } from 'react';
import { X, ChevronLeft, ChevronRight, Info, Instagram } from 'lucide-react';

interface AboutUsProps {
    config: ClientConfig;
}

export default function AboutUs({ config }: AboutUsProps) {
    const [isOpen, setIsOpen] = useState(false);
    const [currentImage, setCurrentImage] = useState(0);

    const gallery = config.assets.gallery || [];

    if (!config.features.showAboutUs || gallery.length === 0) return null;

    const nextImage = () => {
        setCurrentImage((prev) => (prev + 1) % gallery.length);
    };

    const prevImage = () => {
        setCurrentImage((prev) => (prev - 1 + gallery.length) % gallery.length);
    };

    const accentColor = config.theme.accentColor || config.theme.primaryColor;

    return (
        <>
            {/* Trigger Button */}
            <button
                onClick={() => setIsOpen(true)}
                className="w-full py-4 rounded-3xl font-semibold text-lg flex items-center justify-center gap-3 transition-all duration-300 hover:scale-[1.02] active:scale-95 shadow-lg"
                style={{
                    backgroundColor: config.theme.primaryColor,
                    color: config.theme.secondaryColor,
                }}
            >
                <Info size={20} />
                Acerca de Nosotros
            </button>

            {/* Modal */}
            {isOpen && (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-300">
                    <div
                        className="relative w-full max-w-lg rounded-4xl overflow-hidden shadow-2xl"
                        style={{ backgroundColor: config.theme.secondaryColor }}
                    >
                        {/* Close Button */}
                        <button
                            onClick={() => setIsOpen(false)}
                            className="absolute top-4 right-4 z-10 w-10 h-10 rounded-full flex items-center justify-center transition-colors"
                            style={{
                                backgroundColor: config.theme.primaryColor,
                                color: config.theme.secondaryColor,
                            }}
                        >
                            <X size={20} />
                        </button>

                        {/* Image Carousel */}
                        <div className="relative aspect-[4/3] w-full overflow-hidden">
                            <img
                                src={gallery[currentImage]}
                                alt={`${config.name} - Imagen ${currentImage + 1}`}
                                className="w-full h-full object-cover transition-all duration-500"
                            />

                            {/* Navigation Arrows */}
                            {gallery.length > 1 && (
                                <>
                                    <button
                                        onClick={prevImage}
                                        className="absolute left-3 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full flex items-center justify-center transition-all hover:scale-110"
                                        style={{
                                            backgroundColor: `${config.theme.primaryColor}CC`,
                                            color: config.theme.secondaryColor,
                                        }}
                                    >
                                        <ChevronLeft size={24} />
                                    </button>
                                    <button
                                        onClick={nextImage}
                                        className="absolute right-3 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full flex items-center justify-center transition-all hover:scale-110"
                                        style={{
                                            backgroundColor: `${config.theme.primaryColor}CC`,
                                            color: config.theme.secondaryColor,
                                        }}
                                    >
                                        <ChevronRight size={24} />
                                    </button>
                                </>
                            )}

                            {/* Dots Indicator */}
                            <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2">
                                {gallery.map((_, index) => (
                                    <button
                                        key={index}
                                        onClick={() => setCurrentImage(index)}
                                        className="w-2 h-2 rounded-full transition-all duration-300"
                                        style={{
                                            backgroundColor: index === currentImage
                                                ? accentColor
                                                : `${config.theme.secondaryColor}80`,
                                            transform: index === currentImage ? 'scale(1.3)' : 'scale(1)',
                                        }}
                                    />
                                ))}
                            </div>
                        </div>

                        {/* Content */}
                        <div className="p-6 text-center" style={{ color: config.theme.primaryColor }}>
                            <img
                                src={config.assets.logo}
                                alt={config.name}
                                className="w-40 h-40 mx-auto mb-6 object-contain"
                            />
                            <h2
                                className="text-2xl font-bold mb-2"
                                style={{ fontFamily: config.theme.fontFamily }}
                            >
                                {config.name}
                            </h2>
                            <p className="opacity-80">{config.texts.welcomeSubtitle}</p>

                            {/* Social Media */}
                            {config.social?.instagram && (
                                <div className="mt-6 pt-4 border-t border-current/10">
                                    <a
                                        href={config.social.instagram}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="inline-flex items-center gap-2 px-6 py-3 rounded-full font-semibold transition-all hover:scale-105 shadow-md hover:shadow-lg"
                                        style={{
                                            backgroundColor: config.theme.primaryColor,
                                            color: config.theme.secondaryColor
                                        }}
                                    >
                                        <Instagram size={20} />
                                        SÃ­guenos en Instagram
                                    </a>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            )}
        </>
    );
}
</file>

<file path="src/components/client/ClientHeader.tsx">
import { ClientConfig } from '@/config/types';
import { Crown, LogOut } from 'lucide-react';

interface ClientHeaderProps {
    config: ClientConfig;
    level: number;
    onLogout: () => void;
    showGoldQR: boolean;
}

export default function ClientHeader({ config, level, onLogout, showGoldQR }: ClientHeaderProps) {
    return (
        <header className={`p-4 shadow-sm fixed w-full top-0 z-20 transition-colors ${showGoldQR ? 'bg-black text-amber-400' : 'bg-white'}`}>
            <div className="max-w-md mx-auto relative flex items-center justify-center h-48">

                {/* Centered Logo */}
                <div className="flex flex-col items-center">
                    {config.assets?.logo ? (
                        <img
                            src={config.assets.logo}
                            alt={config.name}
                            className="h-44 w-auto object-contain"
                        />
                    ) : (
                        <h1 className="text-xl font-bold">{config.name}</h1>
                    )}
                </div>

                {/* Absolute Level Badge (Right of Logo) */}
                {level > 1 && (
                    <div className="absolute right-12 top-1/2 -translate-y-1/2">
                        <span className="bg-amber-100 text-amber-700 text-[10px] px-2 py-1 rounded-full font-bold flex items-center gap-1 shadow-sm border border-amber-200">
                            <Crown size={10} /> Lv {level}
                        </span>
                    </div>
                )}

                {/* Logout Button (Top Right) */}
                <button
                    onClick={onLogout}
                    className="absolute right-0 top-1/2 -translate-y-1/2 p-2 text-gray-400 hover:text-red-500 transition"
                >
                    <LogOut size={20} />
                </button>
            </div>
        </header>
    );
}
</file>

<file path="src/components/client/MenuButton.tsx">
import { ClientConfig } from '@/config/types';
import { Coffee } from 'lucide-react';
import Link from 'next/link';

interface MenuButtonProps {
    config: ClientConfig;
}

export default function MenuButton({ config }: MenuButtonProps) {
    const isInternal = config.features.menuEnabled;
    const externalUrl = config.features.externalMenuUrl;

    if (isInternal) {
        return (
            <Link href="/client/menu" className="w-full">
                <button
                    className="w-full py-4 text-white rounded-2xl font-bold flex items-center justify-center gap-2 shadow-lg hover:brightness-110 active:scale-95 transition-all"
                    style={{ backgroundColor: config.theme.primaryColor }}
                >
                    <Coffee size={20} /> Ver Nuestro MenÃº
                </button>
            </Link>
        );
    }

    if (externalUrl) {
        return (
            <button
                onClick={() => window.open(externalUrl, '_blank')}
                className="w-full py-4 text-white rounded-2xl font-bold flex items-center justify-center gap-2 shadow-lg hover:brightness-110 active:scale-95 transition-all"
                style={{ backgroundColor: config.theme.primaryColor }}
            >
                <Coffee size={20} /> Ver Nuestro MenÃº
            </button>
        );
    }

    return null;
}
</file>

<file path="src/components/client/NewsFeed.tsx">
'use client';

import { useEffect, useState } from 'react';
import { supabase } from '@/lib/supabase';
import { Bell, Calendar, Star } from 'lucide-react';

interface NewsItem {
    id: string;
    title: string;
    content: string;
    image_url?: string;
    category?: string;
    created_at: string;
    active: boolean;
}

export default function NewsFeed() {
    const [news, setNews] = useState<NewsItem[]>([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchNews = async () => {
            // In a real implementation this table 'news_feed' would exist
            const { data } = await supabase
                .from('news_feed')
                .select('*')
                .eq('active', true)
                .order('created_at', { ascending: false });

            if (data) setNews(data);
            setLoading(false);
        };
        fetchNews();
    }, []);

    if (loading) return <div className="p-4 text-center opacity-50 text-sm">Cargando novedades...</div>;

    return (
        <div className="space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-700 delay-150">
            <div className="flex items-center gap-2 px-2">
                <Bell size={16} className="text-amber-600" />
                <h3 className="font-bold text-gray-800 text-sm uppercase tracking-wide">Novedades y Eventos</h3>
            </div>

            {news.length === 0 ? (
                <div className="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 text-center">
                    <div className="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <Star size={24} className="text-amber-500" />
                    </div>
                    <p className="text-gray-500 text-sm">Â¡Pronto tendremos novedades para ti!</p>
                    <p className="text-gray-400 text-xs mt-1">Promociones, eventos y mÃ¡s.</p>
                </div>
            ) : (
                <div className="flex flex-col gap-4">
                    {news.map((item) => (
                        <div key={item.id} className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 flex gap-4 min-h-[100px]">
                            {item.image_url && (
                                <div className="w-24 h-24 shrink-0 rounded-xl bg-gray-100 overflow-hidden">
                                    <img src={item.image_url} alt={item.title} className="w-full h-full object-cover" />
                                </div>
                            )}
                            <div className="flex-1 flex flex-col justify-center">
                                <div className="flex items-center gap-2 mb-1">
                                    <span className="bg-amber-100 text-amber-700 text-[10px] font-bold px-2 py-0.5 rounded-full uppercase">
                                        {item.category || 'Novedad'}
                                    </span>
                                    <span className="text-[10px] text-gray-400">{new Date(item.created_at).toLocaleDateString()}</span>
                                </div>
                                <h4 className="font-bold text-gray-900 leading-tight mb-1">{item.title}</h4>
                                <p className="text-xs text-gray-500 line-clamp-2">{item.content}</p>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}
</file>

<file path="src/components/client/QRFloatingButton.tsx">
import { QrCode } from 'lucide-react';

interface QRFloatingButtonProps {
    onClick: () => void;
    primaryColor: string;
}

export default function QRFloatingButton({ onClick, primaryColor }: QRFloatingButtonProps) {
    return (
        <button
            onClick={onClick}
            className="fixed bottom-6 right-6 z-40 text-white p-4 rounded-full shadow-xl hover:scale-110 active:scale-95 transition-all animate-bounce-slow"
            style={{ backgroundColor: primaryColor }}
            aria-label="Mi QR"
        >
            <QrCode size={28} />
        </button>
    );
}
</file>

<file path="src/components/client/QRModal.tsx">
import { ClientConfig } from '@/config/types';
import QRCode from 'react-qr-code';
import { Gift, X } from 'lucide-react';

interface QRModalProps {
    isOpen: boolean;
    onClose: () => void;
    userUUID: string | null;
    isRewardReady: boolean;
    config: ClientConfig;
}

export default function QRModal({ isOpen, onClose, userUUID, isRewardReady, config }: QRModalProps) {
    if (!isOpen) return null;

    const accentColor = config.theme.accentColor || '#d97706'; // Fallback to amber-600

    return (
        <div className="fixed inset-0 z-50 flex items-end justify-center sm:items-center font-sans" style={{ fontFamily: config.theme.fontFamily }}>
            {/* Backdrop */}
            <div
                className="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity"
                onClick={onClose}
            />

            {/* Modal Content */}
            <div
                className={`relative w-full max-w-md rounded-t-4xl sm:rounded-4xl p-8 shadow-2xl transform transition-transform duration-300 ease-out ${isOpen ? 'translate-y-0' : 'translate-y-full'}`}
                style={{
                    backgroundColor: config.theme.secondaryColor,
                    color: config.theme.primaryColor,
                    border: `1px solid ${config.theme.primaryColor}20`
                }}
            >
                {/* Close Handle / Button */}
                <div className="flex justify-center mb-4 sm:hidden">
                    <div className="w-12 h-1.5 rounded-full opacity-20" style={{ backgroundColor: config.theme.primaryColor }} />
                </div>

                <button
                    onClick={onClose}
                    className="absolute top-4 right-4 p-2 transition-transform hover:scale-110 sm:block hidden"
                    style={{ color: config.theme.primaryColor }}
                >
                    <X size={24} />
                </button>

                <div className="flex flex-col items-center gap-6 text-center">

                    {/* Branding Logo (Optional but nice) */}
                    <div className="w-16 h-16 rounded-full flex items-center justify-center mb-[-10px] shadow-sm" style={{ backgroundColor: config.theme.secondaryColor }}>
                        <img src={config.assets.logo} alt="Logo" className="w-12 h-12 object-contain" />
                    </div>

                    {isRewardReady ? (
                        <div className="space-y-2">
                            <h2 className="text-2xl font-bold flex items-center justify-center gap-2" style={{ color: accentColor }}>
                                <Gift size={28} className="animate-bounce" />
                                Â¡Premio Listo!
                            </h2>
                            <p className="font-medium opacity-80">Muestra este cÃ³digo para canjear tu bebida gratis.</p>
                        </div>
                    ) : (
                        <div className="space-y-1">
                            <h2 className="text-2xl font-bold">Tu CÃ³digo</h2>
                            <p className="opacity-70">Muestra esto al barista para sumar sellos.</p>
                        </div>
                    )}

                    {/* QR Code Container */}
                    <div
                        className="p-4 bg-white rounded-3xl shadow-inner relative transition-all"
                        style={{
                            boxShadow: `0 10px 30px -10px ${config.theme.primaryColor}30`,
                            border: isRewardReady ? `4px solid ${accentColor}` : 'none'
                        }}
                    >
                        {userUUID ? (
                            <QRCode
                                value={userUUID}
                                size={220}
                                fgColor={config.theme.primaryColor}
                                bgColor="#FFFFFFFF" // Keep QR background white for readability
                            />
                        ) : (
                            <div className="w-[220px] h-[220px] bg-gray-100 animate-pulse rounded-xl" />
                        )}

                        {isRewardReady && (
                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none opacity-20">
                                <Gift size={120} style={{ color: accentColor }} />
                            </div>
                        )}
                    </div>

                    <p className="text-xs opacity-50 mt-2 uppercase tracking-widest">
                        {config.name}
                    </p>

                    <button
                        onClick={onClose}
                        className="w-full py-4 mt-2 font-bold rounded-2xl transition-all hover:opacity-90 active:scale-95"
                        style={{
                            backgroundColor: config.theme.primaryColor,
                            color: config.theme.secondaryColor
                        }}
                    >
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/components/client/RewardsCard.tsx">
import { ClientConfig } from '@/config/types';
import { Gift } from 'lucide-react';

interface RewardsCardProps {
    config: ClientConfig;
    isRewardReady: boolean;
    onOpenQR: () => void;
}

export default function RewardsCard({ config, isRewardReady, onOpenQR }: RewardsCardProps) {
    if (!isRewardReady) return null;

    return (
        <div className="w-full">
            <button
                onClick={onOpenQR}
                className="w-full py-4 bg-gradient-to-r from-orange-400 to-orange-600 text-white rounded-2xl font-bold text-xl shadow-lg hover:scale-105 active:scale-95 transition-all flex items-center justify-center gap-2 animate-bounce"
            >
                <Gift size={24} />
                Â¡TIENES UN PREMIO!
            </button>
            <p className="text-center text-xs text-gray-400 mt-2">Toca para mostrar tu QR y canjear</p>
        </div>
    );
}
</file>

<file path="src/components/client/StampProgress.tsx">
import { ClientConfig } from '@/config/types';
import { Coffee } from 'lucide-react';

interface StampProgressProps {
    config: ClientConfig;
    stamps: number;
}

export default function StampProgress({ config, stamps }: StampProgressProps) {
    const percentage = Math.min((stamps / config.rules.stampsPerReward) * 100, 100);

    return (
        <div className="bg-white p-6 rounded-3xl shadow-lg border border-gray-100">
            <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-4">
                    <div className="p-3 rounded-full bg-orange-100 text-orange-600 shadow-sm">
                        <Coffee size={28} />
                    </div>
                    <div>
                        <div className="flex items-baseline gap-1">
                            <p className="font-bold text-3xl">{stamps}</p>
                            <p className="text-sm font-medium text-gray-400">/ {config.rules.stampsPerReward}</p>
                        </div>
                        <p className="text-xs text-gray-500 font-medium uppercase tracking-wide">Sellos acumulados</p>
                    </div>
                </div>
            </div>

            <div className="w-full bg-gray-100 rounded-full h-2.5">
                <div
                    className="bg-orange-500 h-2.5 rounded-full transition-all duration-1000"
                    style={{ width: `${percentage}%` }}
                ></div>
            </div>

            <p className="text-xs text-center mt-2 text-gray-400">
                {stamps >= config.rules.stampsPerReward
                    ? 'Â¡Tienes una bebida gratis disponible!'
                    : `Faltan ${config.rules.stampsPerReward - stamps} sellos para tu premio.`}
            </p>
        </div>
    );
}
</file>

<file path="src/components/client/WelcomeHero.tsx">
import { ClientConfig } from '@/config/types';

interface WelcomeHeroProps {
    config: ClientConfig;
    userName: string;
    showGoldQR: boolean;
}

export default function WelcomeHero({ config, userName, showGoldQR }: WelcomeHeroProps) {
    return (
        <div className="text-center space-y-2">
            {showGoldQR ? (
                <div className="animate-pulse">
                    <h2 className="text-3xl font-bold text-amber-400">Â¡Momento MÃ¡gico! âœ¨</h2>
                    <p className="text-amber-200">Muestrale este cÃ³digo al barista</p>
                </div>
            ) : (
                <>
                    <h2 className="text-2xl font-bold">Hola, {userName || 'Cliente'} ðŸ‘‹</h2>
                    <p className="opacity-80">{config.texts.welcomeSubtitle}</p>
                </>
            )}
        </div>
    );
}
</file>

<file path="src/components/IOSInstallPrompt.tsx">
'use client';

import { useEffect, useState } from 'react';
import { Share, PlusSquare } from 'lucide-react';

export default function IOSInstallPrompt() {
    const [isIOS, setIsIOS] = useState(false);
    const [isStandalone, setIsStandalone] = useState(false);
    const [showPrompt, setShowPrompt] = useState(false);

    useEffect(() => {
        // 1. Detect iOS
        const userAgent = window.navigator.userAgent.toLowerCase();
        const isIosDevice = /iphone|ipad|ipod/.test(userAgent);
        setIsIOS(isIosDevice);

        // 2. Detect Standalone (Installed)
        const isInStandaloneMode = ('standalone' in window.navigator) && (window.navigator as any).standalone;
        setIsStandalone(isInStandaloneMode);

        // 3. Show only if iOS + Not Installed
        if (isIosDevice && !isInStandaloneMode) {
            // Wait a bit to show
            const timer = setTimeout(() => setShowPrompt(true), 2000);
            return () => clearTimeout(timer);
        }
    }, []);

    if (!showPrompt) return null;

    return (
        <div className="fixed bottom-0 left-0 right-0 p-4 z-50 animate-in slide-in-from-bottom duration-500">
            <div className="bg-white/90 backdrop-blur-md border border-gray-200 shadow-2xl rounded-2xl p-4 max-w-sm mx-auto flex flex-col gap-3">
                <div className="flex justify-between items-start">
                    <div>
                        <h3 className="font-bold text-black">Instalar App</h3>
                        <p className="text-xs text-gray-500">Agrega Mare Cafe a tu inicio para una mejor experiencia.</p>
                    </div>
                    <button onClick={() => setShowPrompt(false)} className="text-gray-400 hover:text-gray-600">âœ•</button>
                </div>

                <div className="flex items-center gap-3 text-sm text-gray-700">
                    <span>1. Toca</span>
                    <Share size={20} className="text-blue-500" />
                    <span>(Compartir)</span>
                </div>
                <div className="flex items-center gap-3 text-sm text-gray-700">
                    <span>2. Elige</span>
                    <div className="flex items-center gap-1 font-semibold">
                        <PlusSquare size={20} />
                        Agregar a Inicio
                    </div>
                </div>
            </div>

            {/* Pointer arrow to bottom for Safari typically */}
            <div className="w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-t-[10px] border-t-white mx-auto mt-[-1px] opacity-90 drop-shadow-sm"></div>
        </div>
    );
}
</file>

<file path="src/components/PoweredBy.tsx">
import React from 'react';

export default function PoweredBy() {
    return (
        <div className="w-full py-4 text-center mt-auto">
            <p className="text-[10px] text-gray-400 font-medium tracking-widest uppercase opacity-60 hover:opacity-100 transition-opacity cursor-default">
                Desarrollado por <span className="font-bold text-gray-500">BRANDIA</span>
            </p>
        </div>
    );
}
</file>

<file path="src/components/Scanner.tsx">
'use client';

import React from 'react';
import { Scanner as QrScanner } from '@yudiel/react-qr-scanner';
import { X } from 'lucide-react';

interface ScannerProps {
    onScan: (data: string) => void;
    onClose: () => void;
}

const Scanner: React.FC<ScannerProps> = ({ onScan, onClose }) => {
    return (
        <div className="fixed inset-0 z-50 bg-black bg-opacity-90 flex flex-col items-center justify-center p-4">
            <div className="w-full max-w-md bg-white rounded-xl overflow-hidden shadow-2xl relative">
                <button
                    onClick={onClose}
                    className="absolute top-4 right-4 z-10 bg-white/20 hover:bg-white/40 p-2 rounded-full text-white backdrop-blur-sm transition-colors"
                >
                    <X size={24} color="black" />
                </button>

                <div className="p-4 bg-gray-900 text-white text-center">
                    <h2 className="text-lg font-bold">Escanear CÃ³digo QR</h2>
                    <p className="text-sm opacity-80">Apunta la cÃ¡mara al QR del cliente</p>
                </div>

                <div className="w-full aspect-square bg-black relative">
                    <QrScanner
                        onScan={(result) => {
                            if (result && result.length > 0) {
                                onScan(result[0].rawValue);
                            }
                        }}
                        onError={(error) => console.error(error)}
                        styles={{
                            container: { width: '100%', height: '100%' },
                            video: { width: '100%', height: '100%', objectFit: 'cover' }
                        }}
                    />

                    {/* Overlay for guidance */}
                    <div className="absolute inset-0 border-2 border-white/30 flex items-center justify-center pointer-events-none">
                        <div className="w-48 h-48 border-2 border-white rounded-lg opacity-50 animate-pulse"></div>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default Scanner;
</file>

<file path="src/config/clients/mare_cafe.ts">
import { ClientConfig } from '../types';

export const mareCafeConfig: ClientConfig = {
    code: 'mare_cafe',
    name: 'Mare Cafe',
    theme: {
        primaryColor: '#1E3A8A', // Royal Deep Blue
        secondaryColor: '#F5F5DC', // Beige/Cream
        fontFamily: 'var(--font-playfair)',
    },
    texts: {
        welcomeTitle: 'Mare', // Just "Mare" usually looks cleaner if using the logo font
        welcomeSubtitle: 'PastelerÃ­a y CafÃ© de Especialidad',
        stampCardTitle: 'Tu Tarjeta de Fidelidad',
        rewardsTitle: 'Tus Recompensas',
    },
    rules: {
        stampsPerReward: 7,
    },
    assets: {
        logo: '/logo-mare.png',
    },
    features: {
        showBuyButton: false,
        externalMenuUrl: 'https://instagram.com/marecafe',
        showNewsFeed: true,
        menuEnabled: false,
    },
};
</file>

<file path="src/config/clients/perezoso_cafe.ts">
import { ClientConfig } from '../types';

export const perezosoCafeConfig: ClientConfig = {
    code: 'perezoso_cafe',
    name: 'Perezoso Cafe',
    theme: {
        primaryColor: '#2E2333', // Perezoso Dark Purple
        secondaryColor: '#FFF5E1', // Perezoso Cream
        accentColor: '#F5A623', // Perezoso Orange
        fontFamily: 'var(--font-fredoka)',
    },
    texts: {
        welcomeTitle: 'Perezoso',
        welcomeSubtitle: 'CafÃ© para ir con calma ðŸ¦¥',
        stampCardTitle: 'Tu Tarjeta de Recompensas',
        rewardsTitle: 'Mis Regalos',
    },
    rules: {
        stampsPerReward: 10,
    },
    assets: {
        logo: '/assets/perezoso/LogoPerezoso.png',
        gallery: [
            '/assets/perezoso/image-1.png',
            '/assets/perezoso/image-2.png',
            '/assets/perezoso/image-3.png',
            '/assets/perezoso/image-4.png',
            '/assets/perezoso/image-5.png',
            '/assets/perezoso/image-6.png',
            '/assets/perezoso/image-7.png',
            '/assets/perezoso/image-8.png',
        ],
    },
    social: {
        instagram: 'https://www.instagram.com/perezoso.cafe/',
    },
    features: {
        showBuyButton: true,
        externalMenuUrl: 'https://perezosocafe.com/menu',
        showNewsFeed: true,
        menuEnabled: true,
        showAboutUs: true,
    },
};
</file>

<file path="src/config/types.ts">
export interface ClientConfig {
  code: string;
  name: string;
  theme: {
    primaryColor: string;
    secondaryColor: string;
    accentColor?: string;
    fontFamily?: string;
  };
  texts: {
    welcomeTitle: string;
    welcomeSubtitle: string;
    stampCardTitle: string;
    rewardsTitle: string;
  };
  rules: {
    stampsPerReward: number;
  };
  assets: {
    logo: string;
    favicon?: string;
    gallery?: string[];
  };
  social?: {
    instagram?: string;
  };
  features: {
    showBuyButton?: boolean;
    externalMenuUrl?: string;
    showNewsFeed?: boolean;
    menuEnabled?: boolean;
    showAboutUs?: boolean;
  };
}
</file>

<file path="src/context/ClientConfigContext.tsx">
'use client';

import { createContext, useContext, ReactNode } from 'react';
import { ClientConfig } from '@/config/types';

const ClientConfigContext = createContext<ClientConfig | null>(null);

export function ClientConfigProvider({
    config,
    children
}: {
    config: ClientConfig;
    children: ReactNode;
}) {
    return (
        <ClientConfigContext.Provider value={config}>
            {children}
        </ClientConfigContext.Provider>
    );
}

export function useClientConfig() {
    const context = useContext(ClientConfigContext);
    if (!context) {
        throw new Error('useClientConfig must be used within a ClientConfigProvider');
    }
    return context;
}
</file>

<file path="src/data/menu-data.ts">
import { Product, Category } from '../types/menu';

export const CATEGORIES: Category[] = [
    { id: 'coffee', name: 'CafÃ© de Especialidad' },
    { id: 'bakery', name: 'PastelerÃ­a' },
    { id: 'brunch', name: 'Brunch' },
    { id: 'drinks', name: 'Bebidas FrÃ­as' },
];

export const PRODUCTS: Product[] = [
    {
        id: '1',
        name: 'Espresso Doble',
        description: 'Intenso y concentrado, con notas de chocolate amargo.',
        price: 3500,
        image: '/images/espresso.jpg',
        category: 'coffee',
        attributes: {
            origin: 'Colombia - Huila',
            tastingNotes: ['Cacao', 'Nuez', 'Caramelo'],
            sizes: ['60ml'],
        },
    },
    {
        id: '2',
        name: 'Cappuccino Italiano',
        description: 'Espresso, leche vaporizada y espuma de leche en partes iguales.',
        price: 4500,
        image: '/images/cappuccino.jpg',
        category: 'coffee',
        attributes: {
            origin: 'Blend de la Casa',
            tastingNotes: ['Suave', 'Cremoso'],
            allergens: ['LÃ¡cteos'],
            sizes: ['240ml'],
        },
    },
    {
        id: '3',
        name: 'Latte Vainilla',
        description: 'Espresso con leche texturizada y un toque de jarabe de vainilla artesanal.',
        price: 5200,
        image: '/images/latte.jpg',
        category: 'coffee',
        attributes: {
            origin: 'Brasil - Cerrado',
            tastingNotes: ['Dulce', 'Aromatizado'],
            allergens: ['LÃ¡cteos'],
            sizes: ['300ml'],
        },
    },
    {
        id: '4',
        name: 'Croissant de Almendras',
        description: 'Masa madre hojaldrada, relleno de crema de almendras y decorado con almendras fileteadas.',
        price: 3800,
        image: '/images/croissant.jpg',
        category: 'bakery',
        attributes: {
            allergens: ['Gluten', 'LÃ¡cteos', 'Frutos Secos'],
        },
    },
    {
        id: '5',
        name: 'Tostada de Aguacate',
        description: 'Pan de masa madre, aguacate triturado, huevo pochado y semillas.',
        price: 7500,
        image: '/images/avocado-toast.jpg',
        category: 'brunch',
        attributes: {
            allergens: ['Gluten', 'Huevo'],
        },
    },
    {
        id: '6',
        name: 'Cold Brew',
        description: 'MaceraciÃ³n en frÃ­o por 18 horas. Notas frutales y baja acidez.',
        price: 4800,
        image: '/images/cold-brew.jpg',
        category: 'drinks',
        attributes: {
            origin: 'EtiopÃ­a - Yirgacheffe',
            tastingNotes: ['Floral', 'CÃ­trico', 'Miel'],
            sizes: ['350ml'],
        },
    },
];
</file>

<file path="src/lib/config-loader.ts">
import { ClientConfig } from '../config/types';
import { mareCafeConfig } from '../config/clients/mare_cafe';
import { perezosoCafeConfig } from '../config/clients/perezoso_cafe';

// Map of client codes to their configurations
const clients: Record<string, ClientConfig> = {
    mare_cafe: mareCafeConfig,
    perezoso_cafe: perezosoCafeConfig,
};

// Default to mare_cafe if not specified or found (for safety in MVP)
const DEFAULT_CLIENT = mareCafeConfig;

export function getClientConfig(): ClientConfig {
    const clientCode = process.env.NEXT_PUBLIC_CLIENT_CODE;

    if (!clientCode) {
        console.warn('NEXT_PUBLIC_CLIENT_CODE is not set, using default client.');
        return DEFAULT_CLIENT;
    }

    const config = clients[clientCode];

    if (!config) {
        console.error(`Configuration for client "${clientCode}" not found, using default.`);
        return DEFAULT_CLIENT;
    }

    return config;
}
</file>

<file path="src/lib/shop-service.ts">
import { supabase } from '@/lib/supabase';
import { ClientConfig } from '@/config/types';

// Default config values to fallback if DB fails or is empty, 
// ensuring the app doesn't crash completely.
const DEFAULT_CONFIG: ClientConfig = {
    code: 'default',
    name: 'Loading...',
    theme: {
        primaryColor: '#000000',
        secondaryColor: '#ffffff',
        fontFamily: 'sans-serif'
    },
    texts: {
        welcomeTitle: 'Welcome',
        welcomeSubtitle: '',
        stampCardTitle: 'Rewards',
        rewardsTitle: 'My Rewards'
    },
    rules: { stampsPerReward: 10 },
    assets: { logo: '' },
    features: {
        showBuyButton: false,
        showNewsFeed: false,
        menuEnabled: false
    }
};

export async function getShopConfig(code: string): Promise<ClientConfig | null> {
    try {
        const { data, error } = await supabase
            .from('shops')
            .select('config, name')
            .eq('code', code)
            .single();

        if (error || !data) {
            console.error(`Error fetching config for ${code}:`, error);
            return null;
        }

        // Merge DB config with name and code
        const config = data.config as Partial<ClientConfig>;

        return {
            ...DEFAULT_CONFIG,
            ...config,
            code: code,
            name: data.name
        } as ClientConfig;

    } catch (e) {
        console.error('Unexpected error fetching shop config:', e);
        return null;
    }
}
</file>

<file path="src/lib/supabase-admin.ts">
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;

if (!supabaseUrl || !supabaseServiceRoleKey) {
    throw new Error('Missing Supabase Service Role Key or URL');
}

// Note: This client BYPASSES RLS. Use with caution.
export const supabaseAdmin = createClient(supabaseUrl, supabaseServiceRoleKey, {
    auth: {
        autoRefreshToken: false,
        persistSession: false
    }
});
</file>

<file path="src/lib/supabase.ts">
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

export const supabase = createClient(supabaseUrl, supabaseKey);
</file>

<file path="src/types/menu.ts">
export interface Product {
    id: string;
    name: string;
    description: string;
    price: number;
    image: string;
    category: string;
    attributes?: {
        origin?: string;
        tastingNotes?: string[];
        allergens?: string[];
        sizes?: string[];
    };
}

export interface Category {
    id: string;
    name: string;
}
</file>

<file path="supabase/migrations/02_phase2_schema.sql">
-- MIGRATION: Phase 2 - Role-Based Architecture
-- Run this entire script in the Supabase SQL Editor

-- 1. Create SHOPS table (Multi-tenant support)
create table if not exists shops (
  id uuid default uuid_generate_v4() primary key,
  name text not null,
  admin_pin text not null, -- Simple text for MVP
  config jsonb default '{}'::jsonb,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2. Update PROFILES table
-- Add new columns
alter table profiles add column if not exists full_name text;
alter table profiles add column if not exists phone text;
alter table profiles add column if not exists shop_id uuid references shops(id);

-- Update role Enum constraint
-- We are changing 'staff' to 'barista' for clarity, but if you want to keep 'staff' as 'barista', that's fine too.
-- Let's standardize on: 'customer', 'barista', 'admin'
alter table profiles drop constraint if exists profiles_role_check;
alter table profiles add constraint profiles_role_check check (role in ('customer', 'barista', 'admin'));

-- 3. Create REDEMPTIONS table (For approval queue)
create table if not exists redemptions (
  id uuid default uuid_generate_v4() primary key,
  user_id uuid references profiles(id) not null,
  shop_id uuid references shops(id) not null,
  staff_id uuid references profiles(id), -- Who processed it
  status text check (status in ('pending', 'approved', 'rejected')) default 'pending',
  reward_id text, -- e.g. "free_coffee"
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  processed_at timestamp with time zone
);

-- 4. Update TRANSACTION_LOGS
alter table transaction_logs add column if not exists type text check (type in ('add_stamp', 'redeem_reward')) default 'add_stamp';

-- 5. Enable RLS on new tables
alter table shops enable row level security;
alter table redemptions enable row level security;

-- 6. Setup Basic Policies (Open for now, restricted later)
create policy "Shops are viewable by public" on shops for select using (true);

create policy "Users view own redemptions" on redemptions for select using (auth.uid() = user_id);
create policy "Staff view shop redemptions" on redemptions for select using (
  exists (select 1 from profiles p where p.id = auth.uid() and p.role in ('barista', 'admin'))
);

create policy "Staff can update redemptions" on redemptions for update using (
  exists (select 1 from profiles p where p.id = auth.uid() and p.role in ('barista', 'admin'))
);

-- 7. SEED DATA: Create the first Shop 'Mare Cafe'
insert into shops (name, admin_pin, config)
values ('Mare Cafe', '1234', '{"theme": "brown"}'::jsonb)
on conflict do nothing;

-- NOTE: You will need to manually link your existing staff profile to this shop_id once created.
</file>

<file path="supabase/migrations/03_fix_function.sql">
-- FIX: Update add_stamp function to recognize 'barista' role
-- Run this in Supabase SQL Editor

create or replace function add_stamp(target_user_id uuid)
returns void
language plpgsql
security definer
as $$
declare
  caller_role text;
begin
  -- Check if caller is barista or admin
  select role into caller_role from profiles where id = auth.uid();
  
  -- Updated check to include 'barista'
  if caller_role not in ('barista', 'staff', 'admin') then
    raise exception 'Unauthorized: Only staff can add stamps.';
  end if;

  -- 1. Upsert stamp count
  insert into stamps (user_id, count)
  values (target_user_id, 1)
  on conflict (user_id)
  do update set 
    count = stamps.count + 1,
    updated_at = now();

  -- 2. Log transaction
  insert into transaction_logs (staff_id, user_id)
  values (auth.uid(), target_user_id);
  
end;
$$;
</file>

<file path="supabase/migrations/04_rename_role.sql">
-- MIGRATION: Rename 'barista' role to 'staff'
-- Run this in Supabase SQL Editor

-- 1. Update existing profiles (if any were created as 'barista')
update profiles set role = 'staff' where role = 'barista';

-- 2. Update the constraint to allow 'staff' instead of 'barista'
alter table profiles drop constraint if exists profiles_role_check;
alter table profiles add constraint profiles_role_check check (role in ('customer', 'staff', 'admin'));

-- 3. Update redemptions policies or triggers if they hardcoded 'barista' (The previous policies used 'barista' in the list, we need to update expected values if strictly checked, but RLS usually just checks the current row).
-- Re-applying RLS for clarity:
drop policy if exists "Staff view shop redemptions" on redemptions;
create policy "Staff view shop redemptions" on redemptions for select using (
  exists (select 1 from profiles p where p.id = auth.uid() and p.role in ('staff', 'admin'))
);

drop policy if exists "Staff can update redemptions" on redemptions;
create policy "Staff can update redemptions" on redemptions for update using (
  exists (select 1 from profiles p where p.id = auth.uid() and p.role in ('staff', 'admin'))
);

-- 4. Verify add_stamp function (It already checked for 'staff' in my previous fix, but let's be sure).
-- No change needed if 03_fix_function.sql was run, as it allowed ('barista', 'staff', 'admin').
</file>

<file path="supabase/migrations/05_security_rules.sql">
-- SECURITY UPDATE: 24h Cooldown Logic
-- Run this in Supabase SQL Editor

-- Drop previous function signature to allow adding new parameter
drop function if exists add_stamp(uuid);

create or replace function add_stamp(target_user_id uuid, force_override boolean default false)
returns jsonb
language plpgsql
security definer
as $$
declare
  caller_role text;
  last_scan timestamp;
  shop_config jsonb;
  result_message text;
begin
  -- 1. Check permissions
  select role into caller_role from profiles where id = auth.uid();
  if caller_role not in ('staff', 'admin') then
    return jsonb_build_object('success', false, 'message', 'Unauthorized');
  end if;

  -- 2. Check 24h Rule (Unless forced)
  if not force_override then
      select created_at into last_scan 
      from transaction_logs 
      where user_id = target_user_id 
        and type = 'add_stamp'
        and created_at > (now() - interval '24 hours')
      order by created_at desc 
      limit 1;

      if last_scan is not null then
         return jsonb_build_object('success', false, 'code', 'COOLDOWN_ACTIVE', 'message', 'Ya se escaneÃ³ hace menos de 24hs.');
      end if;
  end if;

  -- 3. Proceed to Add Stamp
  insert into stamps (user_id, count)
  values (target_user_id, 1)
  on conflict (user_id)
  do update set 
    count = stamps.count + 1,
    updated_at = now();

  -- 4. Log Transaction
  insert into transaction_logs (staff_id, user_id, type)
  values (auth.uid(), target_user_id, 'add_stamp');
  
  return jsonb_build_object('success', true, 'message', 'Sello agregado correctamente');
end;
$$;
</file>

<file path="supabase/migrations/06_redeem_logic.sql">
-- LOGIC: Reward Redemption
-- Run this in Supabase SQL Editor

create or replace function redeem_reward(target_user_id uuid)
returns jsonb
language plpgsql
security definer
as $$
declare
  current_stamps int;
  caller_role text;
begin
  -- 1. Check permissions (Staff/Admin only)
  select role into caller_role from profiles where id = auth.uid();
  if caller_role not in ('staff', 'admin') then
    return jsonb_build_object('success', false, 'message', 'Unauthorized');
  end if;

  -- 2. Check Balance
  select count into current_stamps from stamps where user_id = target_user_id;
  
  if current_stamps is null or current_stamps < 7 then
     return jsonb_build_object('success', false, 'message', 'El cliente no tiene suficientes sellos (MÃ­nimo 7).');
  end if;

  -- 3. Deduct Stamps (Reset to 0 or subtract 7)
  -- Strategy: Subtract 7 to allow "overflow" if they had 8? Or Reset?
  -- Requirement says "Reset to 0" (implied "Cada 7 sellos es un cafe"). 
  -- Let's subtract 7 to be fair if they have 8.
  update stamps set count = count - 7, updated_at = now() where user_id = target_user_id;

  -- 4. Log Transaction
  insert into transaction_logs (staff_id, user_id, type)
  values (auth.uid(), target_user_id, 'redeem_reward');

  return jsonb_build_object('success', true, 'message', 'Â¡Canje exitoso! Se restaron 7 sellos.');
end;
$$;
</file>

<file path="supabase/migrations/07_gamification.sql">
-- MIGRATION: Phase 5 - Gamification (Levels & Preferences)
-- Run this in Supabase SQL Editor

-- 1. Add Level and Preferences to Profiles
alter table profiles 
add column if not exists level int default 1,
add column if not exists preferences jsonb default '{}'::jsonb;

-- 2. Update 'redeem_reward' to increment level
create or replace function redeem_reward(target_user_id uuid)
returns jsonb
language plpgsql
security definer
as $$
declare
  current_stamps int;
  caller_role text;
  new_level int;
begin
  -- Check permissions (Staff/Admin only)
  select role into caller_role from profiles where id = auth.uid();
  if caller_role not in ('staff', 'admin') then
    return jsonb_build_object('success', false, 'message', 'Unauthorized');
  end if;

  -- Check Stamps
  select count into current_stamps from stamps where user_id = target_user_id;
  
  if current_stamps is null or current_stamps < 7 then
     return jsonb_build_object('success', false, 'message', 'El cliente no tiene suficientes sellos (MÃ­nimo 7).');
  end if;

  -- Deduct Stamps
  update stamps set count = count - 7, updated_at = now() where user_id = target_user_id;

  -- Log Transaction
  insert into transaction_logs (staff_id, user_id, type)
  values (auth.uid(), target_user_id, 'redeem_reward');

  -- GAMIFICATION: Level Up!
  update profiles 
  set level = coalesce(level, 1) + 1 
  where id = target_user_id
  returning level into new_level;

  return jsonb_build_object(
      'success', true, 
      'message', 'Â¡Canje exitoso! Se restaron 7 sellos.',
      'new_level', new_level
  );
end;
$$;
</file>

<file path="supabase/migrations/20240201173000_create_campaigns.sql">
-- Create Campaigns Table
create table if not exists campaigns (
  id uuid default gen_random_uuid() primary key,
  title text not null,
  content text,
  status text default 'active', -- 'active' | 'inactive'
  audience text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  metadata jsonb default '{}'::jsonb -- For storing rich content or editor config
);

-- Enable RLS
alter table campaigns enable row level security;

-- Policies (Admin only for now, maybe public read if needed for Client page check but let's stick to safe defaults)
-- Actually, the client page needs to read the campaign status. So 'anon' needs SELECT.
create policy "Public campaigns" on campaigns for select using (true);

-- Only Admin can insert/update
create policy "Admins can manage campaigns" on campaigns for all using (
  auth.uid() in (select id from profiles where role = 'admin')
);
</file>

<file path="supabase/migrations/20240204_client_features.sql">
-- Add contact details to profiles if not exists
alter table profiles 
add column if not exists full_name text,
add column if not exists phone text;

-- Create News Feed Table
create table if not exists news_feed (
  id uuid default uuid_generate_v4() primary key,
  title text not null,
  content text,
  image_url text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  active boolean default true
);

-- RLS for News Feed
alter table news_feed enable row level security;

-- Customers can view active feed
create policy "Customers can view active news"
  on news_feed for select
  using ( active = true );

-- Staff/Admin can manage feed
create policy "Staff can manage news"
  on news_feed for all
  using ( 
    exists (
      select 1 from profiles
      where profiles.id = auth.uid() and profiles.role in ('staff', 'admin')
    ) 
  );
</file>

<file path="supabase/migrations/20260208_create_shops_table.sql">
-- Create SHOPS table
drop table if exists shops cascade;
create table if not exists shops (
    code text primary key,
    name text not null,
    config jsonb not null default '{}'::jsonb,
    created_at timestamp with time zone default timezone('utc'::text, now()) not null,
    updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Enable RLS
alter table shops enable row level security;

-- Policy: Everyone can read shop configs (needed for login/landing pages)
create policy "Allow public read access to shops"
    on shops for select
    using (true);

-- Policy: Only admins can update (future proofing)
-- For now we can leave it open or restrict to service_role

-- Seed Data: Perezoso Cafe
insert into shops (code, name, config)
values (
    'perezoso_cafe',
    'Perezoso Cafe',
    '{
        "theme": {
            "primaryColor": "#2E2333",
            "secondaryColor": "#FFF5E1",
            "accentColor": "#F5A623",
            "fontFamily": "var(--font-fredoka)"
        },
        "texts": {
            "welcomeTitle": "Perezoso",
            "welcomeSubtitle": "CafÃ© para ir con calma ðŸ¦¥",
            "stampCardTitle": "Tu Tarjeta de Recompensas",
            "rewardsTitle": "Mis Regalos"
        },
        "rules": {
            "stampsPerReward": 10
        },
        "assets": {
            "logo": "/assets/perezoso/LogoPerezoso.png",
            "gallery": [
                "/assets/perezoso/image-1.png",
                "/assets/perezoso/image-2.png",
                "/assets/perezoso/image-3.png",
                "/assets/perezoso/image-4.png",
                "/assets/perezoso/image-5.png",
                "/assets/perezoso/image-6.png",
                "/assets/perezoso/image-7.png",
                "/assets/perezoso/image-8.png"
            ]
        },
        "social": {
            "instagram": "https://www.instagram.com/perezoso.cafe/"
        },
        "features": {
            "showBuyButton": true,
            "externalMenuUrl": "https://perezosocafe.com/menu",
            "showNewsFeed": true,
            "menuEnabled": true,
            "showAboutUs": true
        }
    }'::jsonb
)
on conflict (code) do update set config = EXCLUDED.config;

-- Seed Data: Mare Cafe
insert into shops (code, name, config)
values (
    'mare_cafe',
    'Mare Cafe',
    '{
        "theme": {
            "primaryColor": "#1E3A8A",
            "secondaryColor": "#F5F5DC",
            "fontFamily": "var(--font-playfair)"
        },
        "texts": {
            "welcomeTitle": "Mare",
            "welcomeSubtitle": "PastelerÃ­a y CafÃ© de Especialidad",
            "stampCardTitle": "Tu Tarjeta de Fidelidad",
            "rewardsTitle": "Tus Recompensas"
        },
        "rules": {
            "stampsPerReward": 7
        },
        "assets": {
            "logo": "/logo-mare.png"
        },
        "features": {
            "showBuyButton": false,
            "externalMenuUrl": "https://instagram.com/marecafe",
            "showNewsFeed": true,
            "menuEnabled": false
        }
    }'::jsonb
)
on conflict (code) do update set config = EXCLUDED.config;
</file>

<file path="supabase/migrations/20260208_fix_redeem_logic_dynamic.sql">
-- MIGRATION: Fix Redeem Logic to be Dynamic
-- This replaces the function create in 07_gamification.sql / 06_redeem_logic.sql

create or replace function redeem_reward(target_user_id uuid)
returns jsonb
language plpgsql
security definer
as $$
declare
  current_stamps int;
  stamps_needed int;
  caller_role text;
  user_shop_id uuid;
  shop_config jsonb;
  default_stamps int := 10; -- Default fallback if config sucks
  new_level int;
begin
  -- Check permissions (Staff/Admin only)
  select role into caller_role from profiles where id = auth.uid();
  if caller_role not in ('staff', 'admin') then
    return jsonb_build_object('success', false, 'message', 'Unauthorized');
  end if;

  -- Get User's Shop via Profile
  select shop_id into user_shop_id from profiles where id = target_user_id;
  
  -- Get Shop Config
  if user_shop_id is not null then
      select config into shop_config from shops where id = user_shop_id;
      -- Try to read rules.stampsPerReward from jsonb
      -- Note: JSONB extraction depends on structure: {"rules": {"stampsPerReward": 10}}
      stamps_needed := (shop_config->'rules'->>'stampsPerReward')::int;
  end if;

  -- Fallback if null
  if stamps_needed is null then
      stamps_needed := default_stamps; 
  end if;

  -- Check Stamps
  select count into current_stamps from stamps where user_id = target_user_id;
  
  if current_stamps is null or current_stamps < stamps_needed then
     return jsonb_build_object('success', false, 'message', 'El cliente no tiene suficientes sellos (MÃ­nimo ' || stamps_needed || ').');
  end if;

  -- Deduct Stamps
  update stamps set count = count - stamps_needed, updated_at = now() where user_id = target_user_id;

  -- Log Transaction
  insert into transaction_logs (staff_id, user_id, type)
  values (auth.uid(), target_user_id, 'redeem_reward');

  -- GAMIFICATION: Level Up!
  update profiles 
  set level = coalesce(level, 1) + 1 
  where id = target_user_id
  returning level into new_level;

  return jsonb_build_object(
      'success', true, 
      'message', 'Â¡Canje exitoso! Se restaron ' || stamps_needed || ' sellos.',
      'new_level', new_level
  );
end;
$$;
</file>

<file path="supabase/migrations/20260208_secure_pins.sql">
-- Enable pgcrypto for hashing
create extension if not exists "pgcrypto";

-- Add hash columns
alter table shops add column if not exists admin_pin_hash text;
alter table shops add column if not exists staff_pin_hash text;

-- Update with defaults for now (will be changed securely later)
update shops
set 
    admin_pin_hash = crypt('MARE-ADMIN-2024', gen_salt('bf')),
    staff_pin_hash = crypt('1234', gen_salt('bf'))
where admin_pin_hash is null;

-- Secure verification function
create or replace function verify_shop_pin(input_pin text, shop_code text)
returns jsonb
language plpgsql
security definer
as $$
declare
    stored_admin_hash text;
    stored_staff_hash text;
begin
    -- Get hashes for the shop
    select admin_pin_hash, staff_pin_hash 
    into stored_admin_hash, stored_staff_hash
    from shops 
    where config->>'code' = shop_code;

    if not found then
        return jsonb_build_object('valid', false, 'message', 'Shop not found');
    end if;

    -- Check Admin PIn
    if stored_admin_hash is not null and (stored_admin_hash = crypt(input_pin, stored_admin_hash)) then
        return jsonb_build_object('valid', true, 'role', 'admin');
    end if;

    -- Check Staff PIN
    if stored_staff_hash is not null and (stored_staff_hash = crypt(input_pin, stored_staff_hash)) then
         return jsonb_build_object('valid', true, 'role', 'staff');
    end if;

    return jsonb_build_object('valid', false, 'message', 'Invalid PIN');
end;
$$;
</file>

<file path="supabase/schema.sql">
-- Enable UUID extension
create extension if not exists "uuid-ossp";

-- PROFILES TABLE
-- Links to Supabase Auth users
create table profiles (
  id uuid references auth.users not null primary key,
  email text,
  role text check (role in ('customer', 'staff', 'admin')) default 'customer',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Turn on RLS
alter table profiles enable row level security;

-- Policies for Profiles
create policy "Public profiles are viewable by everyone"
  on profiles for select
  using ( true );

create policy "Users can insert their own profile"
  on profiles for insert
  with check ( auth.uid() = id );

create policy "Users can update own profile"
  on profiles for update
  using ( auth.uid() = id );

-- STAMPS TABLE
create table stamps (
  user_id uuid references profiles(id) not null primary key,
  count int default 0,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

alter table stamps enable row level security;

create policy "Users can view own stamps"
  on stamps for select
  using ( auth.uid() = user_id );

-- TRANSACTION LOGS TABLE
create table transaction_logs (
  id uuid default uuid_generate_v4() primary key,
  staff_id uuid references profiles(id) not null,
  user_id uuid references profiles(id) not null,
  location_id text, -- For future multi-branch support
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

alter table transaction_logs enable row level security;

-- Only staff/admin can view transaction logs (or maybe just their own scans?)
create policy "Staff can view logs they created"
  on transaction_logs for select
  using ( auth.uid() = staff_id );

create policy "Admins can view all logs"
  on transaction_logs for select
  using ( 
    exists (
      select 1 from profiles
      where profiles.id = auth.uid() and profiles.role = 'admin'
    ) 
  );

-- DATABASE FUNCTION: Add Stamp
-- Securely adds a stamp and logs the transaction
create or replace function add_stamp(target_user_id uuid)
returns void
language plpgsql
security definer -- Runs with permissions of the function creator (admin)
as $$
declare
  caller_role text;
begin
  -- Check if caller is staff or admin
  select role into caller_role from profiles where id = auth.uid();
  
  if caller_role not in ('staff', 'admin') then
    raise exception 'Unauthorized: Only staff can add stamps.';
  end if;

  -- 1. Upsert stamp count
  insert into stamps (user_id, count)
  values (target_user_id, 1)
  on conflict (user_id)
  do update set 
    count = stamps.count + 1,
    updated_at = now();

  -- 2. Log transaction
  insert into transaction_logs (staff_id, user_id)
  values (auth.uid(), target_user_id);
  
end;
$$;
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.js
.yarn/install-state.gz

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# local env files
.env*.local

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="Auditoria_App_Cafe_Loyalty.md">
# ðŸ” AuditorÃ­a TÃ©cnica Completa â€” App de FidelizaciÃ³n de CafeterÃ­as

**Proyecto:** loyalty-app (Next.js 16 + Supabase + Tailwind 4)  
**Fecha:** 8 de febrero de 2026  
**Stack:** React 19, TypeScript, Supabase (Auth + DB + RLS), Resend, PWA  

---

## 1. RESUMEN EJECUTIVO

Tu app tiene una **base sÃ³lida como MVP funcional**: la arquitectura de componentes es limpia, el sistema de sellos con QR funciona, tienes gamificaciÃ³n bÃ¡sica (niveles), RLS activado, cooldown de 24h, y un panel admin con mÃ©tricas reales. Para ser un MVP es un trabajo muy decente.

Sin embargo, **no estÃ¡ lista para producciÃ³n a escala empresarial**. Tiene problemas crÃ­ticos de seguridad, limitaciones arquitectÃ³nicas fundamentales para multi-tenancy, y carencias que una empresa de primer nivel exigirÃ­a. A continuaciÃ³n el detalle completo.

**CalificaciÃ³n general: 6.5/10** (MVP funcional, no enterprise-ready).

---

## 2. ðŸš¨ PROBLEMAS CRÃTICOS DE SEGURIDAD (Prioridad MÃ¡xima)

### 2.1 Claves API expuestas en el cÃ³digo

Tu archivo `.env.local` estÃ¡ incluido en el XML del repositorio con **claves reales**:

```
NEXT_PUBLIC_SUPABASE_URL=https://guhilwcrdllqoblyxapn.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=sb_publishable_VMhx0bikqr8znZuInYfJ4Q_SPJnh1u5
RESEND_API_KEY=re_eYhe6XgL_2NTyadS9Lzz4WLJqHJnmHyXQ
```

**Riesgo:** Cualquier persona con acceso a este archivo (o al repositorio si se subiÃ³) puede acceder a tu base de datos, enviar emails desde tu cuenta Resend, y manipular datos. **DeberÃ­as rotar estas claves inmediatamente.**

**AcciÃ³n:** AÃ±adir `.env.local` a `.gitignore` (si no estÃ¡), rotar la ANON_KEY y la RESEND_API_KEY desde los dashboards respectivos.

### 2.2 PINs hardcodeados en el cÃ³digo fuente

En `auth/login/page.tsx`:
```typescript
if (shopPin === 'MARE-ADMIN-2024') { finalRole = 'admin'; }
else if (shopPin === '1234') { finalRole = 'staff'; }
```

En `staff/page.tsx`:
```typescript
if (pin === '1234') { /* autoriza canje */ }
```

Y peor aÃºn, en la pestaÃ±a de **Settings del admin**, el PIN maestro se muestra en un input `disabled`:
```html
<input type="password" value="MARE-ADMIN-2024" disabled />
```

**Riesgo:** Cualquiera que inspeccione el cÃ³digo fuente del navegador (F12) ve los PINs. Un atacante podrÃ­a registrarse como admin de cualquier cafeterÃ­a.

**SoluciÃ³n:** Los PINs deben almacenarse hasheados en la base de datos (tabla `shops`), validarse vÃ­a funciÃ³n `security definer` en Supabase, y nunca aparecer en el frontend.

### 2.3 Server Action usa Anon Key en vez de Service Role

En `marketing.ts`:
```typescript
const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;
```

Un Server Action corre en el servidor y **deberÃ­a usar la Service Role Key** para bypasear RLS cuando necesita consultar todos los perfiles para enviar emails masivos. Con la Anon Key, las polÃ­ticas RLS podrÃ­an bloquear la consulta de perfiles de otros usuarios.

---

## 3. ðŸ—ï¸ ARQUITECTURA MULTI-TENANT: Â¿Aguanta 50 cafeterÃ­as?

### Respuesta corta: No con la arquitectura actual.

### Respuesta larga: Tu sistema actual es "multi-config, single-deployment":

**CÃ³mo funciona hoy:**
1. Cada cafeterÃ­a es un archivo de configuraciÃ³n estÃ¡tico (`mare_cafe.ts`, `perezoso_cafe.ts`)
2. La variable `NEXT_PUBLIC_CLIENT_CODE=perezoso_cafe` se fija en build-time
3. `config-loader.ts` carga la config correspondiente al valor del env var
4. Una sola instancia de Supabase para todos

**Problema fundamental:** Para 50 cafeterÃ­as necesitarÃ­as:
- 50 archivos de configuraciÃ³n manualmente creados en cÃ³digo
- 50 deployments separados en Vercel (uno por cada `NEXT_PUBLIC_CLIENT_CODE`)
- O un re-deploy cada vez que cambies algo de una cafeterÃ­a
- Cada cambio de marca requiere tocar cÃ³digo y re-deployar

**Lo que necesitarÃ­as para escalar a 50:**

| Aspecto | Actual | Necesario |
|---------|--------|-----------|
| ConfiguraciÃ³n | Archivos `.ts` estÃ¡ticos | Tabla `shops` en DB con toda la config |
| Routing | 1 deploy = 1 cafeterÃ­a | Subdominios dinÃ¡micos (`perezoso.tuapp.com`) o rutas dinÃ¡micas (`/perezoso/client`) |
| DetecciÃ³n de tenant | `process.env.NEXT_PUBLIC_CLIENT_CODE` | Middleware que lee subdomain o slug de URL |
| Temas | Hardcodeados en config files | Cargados desde DB, aplicados vÃ­a CSS variables |
| Assets (logos, imÃ¡genes) | En `/public` por cafeterÃ­a | En Supabase Storage, servidos dinÃ¡micamente |
| MenÃº | Hardcodeado en `menu-data.ts` | Tabla `products` en DB vinculada a `shop_id` |
| Manifest/PWA | Hardcodeado a "Mare Cafe" | Generado dinÃ¡micamente por endpoint API |

---

## 4. Â¿Puedo cambiar Perezoso completamente sin afectar Mare Cafe?

### SÃ­, PARCIALMENTE.

**Lo que SÃ estÃ¡ aislado:**
- La base de datos tiene `client_code` en `profiles`, asÃ­ que los usuarios de Perezoso no ven/afectan a los de Mare
- Las configuraciones visuales (colores, textos, logo) son archivos separados
- El login verifica `client_code` y rechaza si no coincide

**Lo que NO estÃ¡ aislado y te puede causar problemas:**
- **`layout.tsx`** tiene hardcodeado `title: "Mare Cafe Loyalty"` y `icon: "/logo-mare.png"` â€” esto se ve en TODAS las instancias
- **`manifest.json`** estÃ¡ hardcodeado a Mare Cafe â€” la PWA siempre muestra "Mare Cafe"
- **Las plantillas de email** en admin referencian paths de Mare: `/clients/mare_cafe/flyer_template_*.png`
- **La funciÃ³n `redeem_reward`** hardcodea el umbral de 7 sellos, mientras Perezoso tiene `stampsPerReward: 10` â€” **esto es un BUG**: la DB siempre resta 7 aunque Perezoso requiere 10
- **Las RLS policies no filtran por `client_code`** â€” un admin podrÃ­a potencialmente ver mÃ©tricas de otra cafeterÃ­a si tuviera acceso
- **`fetchMetrics` en admin** cuenta TODOS los perfiles con `role: 'customer'` sin filtrar por `client_code` â€” Mare ve clientes de Perezoso en sus mÃ©tricas

**Bug crÃ­tico encontrado:** En `06_redeem_logic.sql` y `07_gamification.sql`:
```sql
if current_stamps < 7 then  -- HARDCODED, ignora config.rules.stampsPerReward
```
Perezoso tiene `stampsPerReward: 10` pero la DB siempre valida contra 7 y resta 7. DeberÃ­as pasar `stamps_required` como parÃ¡metro de la funciÃ³n o leerlo de la tabla `shops`.

---

## 5. Â¿CuÃ¡ntos usuarios podrÃ­a soportar?

### Depende de tu plan de Supabase:

| Plan Supabase | Conexiones DB | Almacenamiento | Usuarios estimados |
|---------------|---------------|----------------|-------------------|
| Free | 60 conexiones | 500 MB | ~500-1,000 usuarios |
| Pro ($25/mes) | 200 conexiones | 8 GB | ~5,000-15,000 usuarios |
| Team ($599/mes) | 300+ | 100 GB | ~50,000+ usuarios |

**Cuellos de botella actuales:**

1. **Polling cada 3 segundos** en `client/page.tsx`: Cada cliente con el QR abierto hace una query cada 3s. Con 100 clientes simultÃ¡neos = 2,000 queries/minuto solo de polling. **SoluciÃ³n:** Usar Supabase Realtime (suscripciones) en vez de polling.

2. **No hay paginaciÃ³n** en `fetchMetrics` ni en `ClientsTab` â€” si tienes 10,000 clientes, carga todos de golpe.

3. **El envÃ­o de emails es secuencial** con 500ms de delay entre cada uno. Para 10,000 usuarios = ~83 minutos. **SoluciÃ³n:** Usar la API Batch de Resend o una cola de trabajos.

4. **GrÃ¡ficos de admin cargan todos los logs** sin limit. Con miles de transacciones esto se vuelve lento.

---

## 6. Â¿Se podrÃ­an perder los datos/archivos?

### Datos en Supabase (stamps, perfiles, transacciones):
- **Riesgo bajo** si estÃ¡s en el plan Pro: Supabase hace backups diarios automÃ¡ticos
- **Riesgo medio** en plan Free: No tiene backups automÃ¡ticos; si borras algo, se pierde
- **Riesgo real:** No hay soft-delete. Si un admin borra un perfil o un sello por error, no hay forma de recuperarlo

### Archivos estÃ¡ticos (logos, imÃ¡genes):
- EstÃ¡n en `/public` dentro del cÃ³digo, asÃ­ que se versionan con Git â€” no se pierden
- Pero si un usuario sube una plantilla en el admin, se almacena como `base64` en memoria del navegador â€” **se pierde al recargar la pÃ¡gina**. No hay persistencia real de uploads

### Riesgos concretos de pÃ©rdida:
- Sin backup de DB en plan free â†’ riesgo real
- Uploads de templates no se guardan en storage â†’ se pierden
- No hay audit trail completo (la tabla activity tiene datos fake/hardcoded)
- Un cambio errÃ³neo en migraciones SQL podrÃ­a corromper datos sin rollback fÃ¡cil

---

## 7. ANÃLISIS DE FUNCIONALIDADES

### âœ… Lo que funciona bien:

| Feature | Estado | Nota |
|---------|--------|------|
| Sistema de sellos QR | âœ… Funcional | Escaneo â†’ stamp â†’ counter. Flujo completo |
| Cooldown 24h anti-abuso | âœ… Bien pensado | Con override por PIN para excepciones |
| Auth por roles (customer/staff/admin) | âœ… Correcto | SeparaciÃ³n clara con redirects |
| Aislamiento de clientes (client_code) | âš ï¸ Parcial | Funciona en auth, falla en mÃ©tricas y DB functions |
| Panel Admin con mÃ©tricas reales | âœ… Funcional | Charts con Recharts, datos de DB |
| GamificaciÃ³n (niveles) | âœ… BÃ¡sica | Level up al canjear, pide bebida favorita |
| PWA (Install en iOS/Android) | âœ… Implementada | Manifest + IOSInstallPrompt |
| News Feed | âœ… Funcional | Tabla `news_feed` con RLS |
| Email marketing | âœ… Base funcional | Resend + templates + segmentaciÃ³n por nivel |
| CampaÃ±as con QR de promo | âœ… Creativo | QR dinÃ¡mico con campaignId en URL |

### âŒ Lo que falta para ser enterprise-grade:

| Feature faltante | Importancia | DescripciÃ³n |
|-----------------|-------------|-------------|
| Tests automatizados | ðŸ”´ CrÃ­tica | Cero tests. Cualquier cambio puede romper algo sin saberlo |
| Error boundaries | ðŸ”´ CrÃ­tica | Si un componente falla, toda la app crashea (pantalla blanca) |
| Logging/Monitoring | ðŸ”´ CrÃ­tica | Solo `console.log`. Sin Sentry, sin alertas, sin mÃ©tricas de performance |
| Rate limiting en login | ðŸ”´ CrÃ­tica | Nada impide fuerza bruta contra las cuentas |
| ValidaciÃ³n de inputs | ðŸŸ¡ Alta | No hay validaciÃ³n de email format, longitud de password, sanitizaciÃ³n |
| RecuperaciÃ³n de contraseÃ±a | ðŸŸ¡ Alta | No existe flujo de "forgot password" |
| Loading states robustos | ðŸŸ¡ Alta | El loading genÃ©rico "Cargando..." no es great UX |
| Skeleton screens | ðŸŸ¡ Media | No hay placeholders mientras carga |
| Offline support | ðŸŸ¡ Media | Es PWA pero no funciona offline (no hay service worker con cache) |
| Accesibilidad (a11y) | ðŸŸ¡ Media | Sin aria-labels, sin manejo de focus, sin soporte de screen reader |
| i18n/InternacionalizaciÃ³n | ðŸŸ¢ Baja | Todo en espaÃ±ol hardcodeado, no escalable a otros idiomas |
| Dark mode | ðŸŸ¢ Baja | No implementado |

---

## 8. Â¿ES CÃ“DIGO DE EMPRESA DE PRIMER NIVEL?

### No, y aquÃ­ estÃ¡ el por quÃ© comparado:

**Lo que harÃ­a una empresa tier-1 (Starbucks, Blue Bottle, etc.) que tu app no tiene:**

1. **Infraestructura:** Microservicios o al menos API Routes dedicadas con validaciÃ³n. Tu app mezcla lÃ³gica de negocio en componentes de UI (`staff/page.tsx` tiene ~200 lÃ­neas de lÃ³gica de escaneo mezclada con rendering).

2. **Seguridad:** OAuth2/SSO, 2FA, tokens rotados, secrets management (Vault/AWS Secrets Manager), WAF, penetration testing regular. Tu app usa PINs de 4 dÃ­gitos en texto plano.

3. **Testing:** MÃ­nimo 80% coverage con unit tests, integration tests, E2E (Playwright/Cypress). Tu app tiene 0 tests.

4. **CI/CD:** Pipeline con linting, testing, security scanning, staging environments, blue-green deployments. Tu app no tiene pipeline visible.

5. **Observabilidad:** APM (Datadog/New Relic), error tracking (Sentry), structured logging, dashboards de salud. Tu app tiene `console.log`.

6. **Multi-tenancy real:** DB-level isolation (schemas separados o Row-Level filtering consistente), tenant management dashboard, onboarding automatizado. Tu app requiere editar cÃ³digo para cada cafeterÃ­a nueva.

7. **DocumentaciÃ³n:** API docs, runbooks, architecture decision records. Tu README es bÃ¡sico.

### Pero eso no significa que estÃ© mal para lo que es.

Para un **MVP/startup en fase temprana** con 2-5 cafeterÃ­as, tu app estÃ¡ en un **nivel respetable**. Tienes las bases: RLS, auth por roles, aislamiento parcial, sistema de sellos funcional, panel admin con data real. El camino de MVP a enterprise es largo pero tienes los cimientos.

---

## 9. ROADMAP DE MEJORAS RECOMENDADO

### Fase 1: Urgente (esta semana)
- [ ] Rotar TODAS las API keys expuestas
- [ ] Mover PINs a la base de datos (tabla `shops`) hasheados con bcrypt
- [ ] Arreglar bug de `stampsPerReward` hardcodeado en SQL (pasar como parÃ¡metro)
- [ ] Dinamizar `layout.tsx` y `manifest.json` con datos de config
- [ ] Filtrar mÃ©tricas de admin por `client_code`

### Fase 2: Corto plazo (1-2 semanas)
- [ ] Reemplazar polling por Supabase Realtime
- [ ] Usar Service Role Key en Server Actions
- [ ] AÃ±adir Error Boundaries en componentes crÃ­ticos
- [ ] Implementar "forgot password"
- [ ] AÃ±adir paginaciÃ³n en ClientsTab y logs
- [ ] Mover menu-data a tabla en DB vinculada a shop_id

### Fase 3: Medio plazo (1-2 meses)
- [ ] Migrar configs de archivos estÃ¡ticos a tabla `shops` con toda la personalizaciÃ³n
- [ ] Implementar routing multi-tenant (subdominios o `/[slug]/`)
- [ ] AÃ±adir tests (al menos para funciones de DB y flujos crÃ­ticos)
- [ ] Integrar Sentry para error tracking
- [ ] Implementar Supabase Storage para logos y assets

### Fase 4: Escalabilidad (2-4 meses)
- [ ] Dashboard de onboarding para nuevas cafeterÃ­as (sin tocar cÃ³digo)
- [ ] API batch para emails
- [ ] CDN para assets estÃ¡ticos
- [ ] Cache layer (Redis o similar)
- [ ] Pipeline CI/CD completo

---

## 10. CONCLUSIÃ“N

**Tu app es un MVP sÃ³lido con potencial real**, pero necesita trabajo significativo antes de poder venderse como plataforma SaaS a 50 cafeterÃ­as. Los problemas mÃ¡s urgentes son de seguridad (claves expuestas, PINs en cÃ³digo) y el bug de `stampsPerReward`. La arquitectura multi-tenant necesita una refactorizaciÃ³n fundamental para escalar mÃ¡s allÃ¡ de 3-5 clientes sin dolor operativo.

La buena noticia: la base tecnolÃ³gica (Next.js + Supabase + Tailwind) es perfectamente capaz de soportar lo que necesitas. El problema no es el stack, es la implementaciÃ³n actual que fue diseÃ±ada para 1-2 clientes y necesita evolucionar.

**Mi recomendaciÃ³n:** Arregla la seguridad hoy, arregla el bug de stamps esta semana, y planifica la migraciÃ³n a multi-tenancy real como tu siguiente sprint. Con esos cambios, estarÃ¡s en camino a una plataforma que realmente puedas vender.
</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="next.config.ts">
import type { NextConfig } from "next";
import withPWAInit from "@ducanh2912/next-pwa";

const withPWA = withPWAInit({
  dest: "public",
  disable: process.env.NODE_ENV === "development", // Disable in dev to avoid noise
  register: true,
});

const nextConfig: NextConfig = {
  experimental: {
  },
  turbopack: {
    root: process.cwd(),
  },
};

export default withPWA(nextConfig);
</file>

<file path="package.json">
{
  "name": "loyalty-app",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@ducanh2912/next-pwa": "^10.2.9",
    "@supabase/supabase-js": "^2.93.3",
    "@yudiel/react-qr-scanner": "^2.2.1",
    "lucide-react": "^0.563.0",
    "next": "16.1.6",
    "qrcode.react": "^4.2.0",
    "react": "19.2.3",
    "react-dom": "19.2.3",
    "react-qr-code": "^2.0.18",
    "recharts": "^3.7.0",
    "resend": "^6.9.1"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.1.6",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

</files>
